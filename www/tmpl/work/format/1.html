

<script type="text/javascript">
var BizFormat = {
	init:function() {
		$('#mode').val('');
		$('#expense_customer').focus();

		var checked = $(':radio[name="team_code_search"]:checked').val();

		$('#team_code').val(checked);
		$('#biz_type').val(WorkBiz.selectSalesBizType(checked));

		HmisCommon.createDatepicker();
		this.createNumber();

		//this.load(1);

		$("#FrmBizInput :input").keypress(function(){
            if (event.keyCode == 13) {
				BizFormat.add();
            }
        });

		if($('#work_type').val() != ''){
			$('.col_span').attr("colSpan",2);
			$('.td_hide').addClass('hide');
		}
	},
	createNumber : function() {
		var me = this;
		$("input.number").attr('placeholder','0');
		$("input.number").attr('autocomplete','off');
		$("input.number").unbind('keyup.number').bind('keyup.number', function(){
			var e = $(this);
			e.val( HmisCommon.numberFormat(e.val()) );
			me.calculatePrice(e.data('group'), e.data('name'));	
		
		})
	},
	add : function() {

		var formdata = $('#FrmBizInput').serialize();
		var biz_type = $('#biz_type').val();
		$.ajax({
			url : "/work_proc/add_biz_sales_log",
			data : formdata,
			dataType:'json',
			type : "POST",
			success : function(r) {
				if(r.success){
					WorkBiz.load(biz_type);
				}
				else {
					HmisAlert.alert('잠시 후에 다시 시도해주세요.');
				}

			}
		});
	},
	remove :function(no) {
		HmisAlert.confirm('삭제하시겠습니까?', function(r) {
			if(r) {
				var formdata = $('#FrmBizInput').serialize();
				var biz_type = $('#biz_type').val();
				$.ajax({
					url : "/work_proc/remove_biz_sales_log",
					data:{
						no:no,
						biz_type:biz_type
					},
					dataType:'json',
					type : "POST",
					success : function(r) {
						if(r.success){
							WorkBiz.load(biz_type);
						}
						else {
							HmisAlert.alert('잠시 후에 다시 시도해주세요.');
						}

					}
				});
			}
			
		});

	},
	calculatePrice : function(group, name) {
		var sum = 0;
		// 총액
		$.each($('input[data-group="'+group+'"]'), function(i,e){
			var price = $(e).val().replace(/,/gi,'');
			if ($.isNumeric(price)) {
				sum+=parseInt(price);
			}
		});
		$('#expense_'+group+'_price').val(HmisCommon.numberFormat(sum));
		//this.calculateTotal(group, name);
	},
	calculateTotal : function(group, name) {
		var total_price = 0;

		$("input:enabled[id^=expense_"+group+"_price]" ).each(function() {
			if( this.value ){
				total_price = parseInt(total_price) + parseInt(this.value.replace(/[^0-9]/g,''));
			}
		});

		$("#total_"+group+"_price").val(total_price.number_format(0));				// 총액

		// 현금, 카드, 계좌, 환불, 미수금
		total_price = 0;
		$.each($('input[name^=expense_'+group+'_'+name+']'), function(i,e){
			if( this.value ){
				total_price = parseInt(total_price) + parseInt(this.value.replace(/[^0-9]/g,''));
			}
		});
		$("#total_"+group+"_"+name).val(total_price.number_format(0));
	},
};

$(function(){
	BizFormat.init();	
});

</script>


<form id="FrmBizInput" onsubmit="return false">
<input type="hidden" name="team_code" id="team_code" value="">
<input type="hidden" name="biz_type" id="biz_type" value="">
<input type="hidden" name="is_schedule" id="is_schedule" value="N">

	<!-- <h3>수술완료고객</h3> -->
	
	<table class="table table-center table-list">
	
	<tr>
	<td>
	<h3 style="text-align:left;">수술완료고객(OP매출)</h3>
	<table class="table table-bordered table-center table-list table-striped table-hover" border="1">
		<colgroup>
			<col width="30px" /><!-- No -->
			<col width="80px" /><!-- 이름 -->
			<col width="100px" /><!-- 유입경로 -->
			<col width="100px" /><!-- 상담일 -->
			<col width="100px" /><!-- 수술일 -->
			<col width="80px" /><!-- 담당의 -->
			<col width="80px" /><!-- 담당실장 -->
			<col width="110px" /><!-- 수술내용 -->
			<col width="80px" /><!-- 총액 -->
			<col width="80px" /><!-- 현금 -->
			<col width="80px" /><!-- 카드 -->
			<col width="80px" /><!-- 계좌 -->
			<col width="80px" /><!-- 환불 -->
			<col width="80px" /><!-- 미수금 -->
			<!-- <col class="col_span"/> -->				<!-- 비고 -->
			<col class="td_hide" width="30px" /><!-- 미수금 -->
		</colgroup>

		<thead>
			<!-- <tr><td colspan="15" style="text-align:left;"><h3>수술완료고객</h3>	</td></tr> -->
			<tr style="background-color:#b6b6b6">
				<th rowspan="2">No</th>
				<th rowspan="2">이름</th>
				<th rowspan="2">유입경로</th>
				<th rowspan="2">상담일</th>
				<th rowspan="2">수술일</th>
				<th rowspan="2">담당의</th>
				<th rowspan="2">담당실장</th>
				<th rowspan="2">수술내용</th>
				<th rowspan="2">총액</th>
				<th colspan="3">수납방식</th>
				<th rowspan="2">환불</th>
				<th rowspan="2">미수금</th>
				<!-- <th rowspan="2" class="col_span">비고</th> -->
				<th rowspan="2" class="td_hide"></th>
			</tr>
			<tr style="background-color:#b6b6b6">
				<th>현금</th>
				<th>카드</th>
				<th>계좌</th>
			</tr>

			
		</thead>
		<tbody>
			{? mode != 'excel' && cfg.work_type == ''}
			<tr class="td_hide">
				<td></td>
				<td><input type='text' class="full" name='expense_customer' id='expense_customer' value='' /></td>	<!-- 이름 -->
				<td>
					<select name='expense_path' id='expense_path'>
						{@ cfg.path_list }
						<option value='{.key_}'>{.value_}</option>
						{/}
					</select>
				</td>		<!-- 유입경로 -->
				<td><input type='text' class='datepicker' name='expense_consulting_date' id='expense_consulting_date' value="<?=date('Y-m-d')?>" /></td>		<!-- 상담일 -->
				<td><input type='text' class='datepicker' name='expense_project_date' value="<?=date('Y-m-d')?>" /></td>			<!-- 수술일 -->
				
				<td>
					<select name='expense_doctor' id='expense_doctor'>
						{@ cfg.work_biz_expense_doctor }
						<option value='{.key_}'>{.value_}</option>
						{/}
					</select>
				</td>		<!-- 담당의 -->

				<td>
					<select name='expense_consultant'>
						{@ cfg.expense_consultant_list }
						<option value='{.key_}'>{.value_['name']}</option>
						{/}
					</select>
				</td>		<!-- 담당실장 -->

				<td><input type='text' class='full' name='expense_desc' id='expense_desc' value=''></td>		<!-- 수술내용 -->
				<!-- 총매출:S -->
				<td><input type='text' class='number full' name='expense_receipt_price' id='expense_receipt_price'  value='' readonly></td>				<!-- 총액 -->
				<td><input type='text' class='number full' name='expense_receipt_money' data-group="receipt" data-name='money' value=''></td>	<!-- 수납방식:현금 -->
				<td><input type='text' class='number full' name='expense_receipt_card' data-group="receipt" data-name='card' value=''></td>		<!-- 수납방식:카드 -->
				<td><input type='text' class='number full' name='expense_receipt_account' data-group="receipt" data-name='account' value=''></td><!-- 수납방식:계좌 -->
				<!-- 총매출:E -->
				<td><input type='text' class='number full' name='expense_deposit_refund' id='expense_deposit_refund' data-group="deposit" data-name='refund' value=''></td><!-- 환불 -->
				<td><input type='text' class='number full' name='expense_deposit_unpaid' id='expense_deposit_unpaid' data-group="deposit" data-name='unpaid' value=''></td><!-- 미수금 -->
				<!-- <td><input type='text' class='full' name='expense_etc' id='expense_etc' value=''></td> -->	<!-- 비고 -->
				<td><span class='badge lg green' onClick='BizFormat.add();' style='cursor:pointer;vertical-align: middle;'><i class="fa fa-plus"></i></span></td>		<!-- 추가버튼 -->
				
			</tr>
			{/}	
			
			{@ list}
			<tr>
				<td>{.idx}</td>
				<td>{.expense_customer}</td>
				<td>{.path}</td>
				<td>{.expense_consulting_date}</td>
				<td>{.expense_project_date}</td>
				<td>{.doctor_name}</td>
				<td>{.expense_consultant_name}</td>
				<td>{.expense_desc}</td>
				<td>{=number_format(.expense_receipt_price)}</td>
				<td>{=number_format(.expense_receipt_money)}</td>
				<td>{=number_format(.expense_receipt_card)}</td>
				<td>{=number_format(.expense_receipt_account)}</td>
				<td>{=number_format(.expense_deposit_refund)}</td>
				<td>{=number_format(.expense_deposit_unpaid)}</td>
				<!-- <td class="col_span" style="text-align:left">{.expense_etc}</td> -->
				<td class="td_hide"><span class='badge lg red' onClick="BizFormat.remove('{.no}')" style='cursor:pointer;vertical-align: middle;'><i class="fa fa-minus"></i></span></td>
			</tr>

			{/}	

			<tr>
				<th colspan="8" style="text-align:center;">합계</th>
				<th>{=number_format(total.expense_receipt_price)}</th>

				<th>{=number_format(total.expense_receipt_money)}</th>
				<th>{=number_format(total.expense_receipt_card)}</th>
				<th>{=number_format(total.expense_receipt_account)}</th>

				<th>{=number_format(total.expense_deposit_refund)}</th>
				<th>{=number_format(total.expense_deposit_unpaid)}</th>
				<!-- <th class="col_span"></th> -->
				<th class="td_hide"></th>
			</tr>

		</tbody>
	</table>
	</td></tr></table>
</form>
