<h3 class="area-title">
	<div>업무이력검색</div>
</h3>

<form id="FrmConsultingWorkSearch" onsubmit="return false">
<input type="hidden" name="grant_biz" value="{layout.page.grant_biz}" /><!-- 사업장권한 -->
<table class="table table-bordered table-form">
	<colgroup>
		<col style="width:120px" />
		<col />
	</colgroup>
	<tbody>
		{? session.dept != 90}
		<tr>
			<th>팀</th>
			<td colspan="1">
				<div class="btn-group hmis blue" data-toggle="buttons" data-default="">
					<label class="btn {? !search.team_code || search.team_code=='all' }active{/}"><input type="radio" name="team_code" value="all" {? !search.team_code || search.team_code=='all' }checked{/} data-role="search" />전체</label>
					{@ cfg.team}
					<label class="btn {? search.team_code==.key_}active{/}"><input type="radio" name="team_code" value="{.key_}" {? search.team_code==.key_}checked{/} data-role="search" />{.value_}</label>
					{/}
				</div>

				<div class="btn-group hmis orange" data-toggle="buttons" id="reg_user_id" style="display:none">
					<label class="btn {? search.reg_user_id =='all'}active{/}"><input type="radio" name="reg_user_id" value="all"  data-role="search" {? search.reg_user_id =='all'}checked{/}  /><span>전체</span></label>
				</div>
			</td>
		</tr>
		{:}
		<tr>
			<th>상담실장</th>
			<td>
				<div class="btn-group hmis blue" data-toggle="buttons" data-default="">
					<label class="btn {? !search.team_code}active{/}"><input type="radio" name="reg_user_id" value="" {? !search.team_code}checked{/} data-role="search" />전체</label>
					{@ cfg.team_member}
					<label class="btn {? search.team_code==.key_}active{/}"><input type="radio" name="reg_user_id" value="{.key_}" {? search.team_code==.key_}checked{/} data-role="search" />{.value_}</label>
					{/}
				</div>
			</td>
		</tr>
		{/}

		<tr>
			<th>작업일</th>
			<td>
				<input type="text" name="date_s" id="sdate_s"  class="datepicker lg" value="{search.date_s}" data-default="{=date('Y-m-d')}" /> ~ <input type="text" name="date_e" id="sdate_e"  class="datepicker lg" value="{search.date_e}"data-default="{=date('Y-m-d')}"  />

				<ul class="btn-group btn-group-xs">
					<li onclick="ConsultingWork.setDate('{cfg.date.today}','{cfg.date.today}');"><a href="javascript:;">오늘</a></li>
					<li onclick="ConsultingWork.setDate('{cfg.date.weekday}','{cfg.date.today}');"><a href="javascript:;">이번주</a></li>
					<li onclick="ConsultingWork.setDate('{cfg.date.cur_month}','{cfg.date.today}');"><a href="javascript:;">이번달</a></li>
					<li onclick="ConsultingWork.setDate('{cfg.date.yesterday}','{cfg.date.yesterday}');"><a href="javascript:;">어제</a></li>
					<li onclick="ConsultingWork.setDate('{cfg.date.pre_week_start_db}','{cfg.date.pre_week_end_db}');"><a href="javascript:;">지난주</a></li>
					<li onclick="ConsultingWork.setDate('{cfg.date.pre_month_start}','{cfg.date.pre_month_end}');"><a href="javascript:;">지난달</a></li>
				</ul>
			</td>
		</tr>
	</tbody>
</table>

<div class="area-button">
	<button type="submit" class="btn btn-lg btn-theme" onclick="ConsultingWork.load(1)"><i class="fa fa-search"></i> 검색</button>
	<button type="button" class="btn btn-lg btn-gray" onclick="ConsultingWork.reset()">처음으로</button>
</div>
</form>

<div class="dashed"></div>
<h3 class="area-title">
	업무이력 목록
	<span class="f-small" style="font-weight:normal;font-size:11px;padding-left:10px">검색된 업무이력 <span id="cnt_search" class="f-bold  f-error">0</span>건 <span class="split">|</span> 총 업무이력 <span id="cnt_total"class="f-bold">0</span>건</span>
</h3>
<table class="table table-responsive table-bordered table-list table-striped table-hover">
	<colgroup>
		<col style="width:60px" /><!-- 번호 -->
		<col style="width:150px" /><!-- 업무일시 -->
		<col style="width:100px" /><!-- 팀 -->
		<col style="width:100px" /><!-- 작업자 -->
		<col style="width:150px" /><!-- 고객명 -->
		<col style="width:100px" /><!-- 현재상태 -->
		<col style="width:100px" /><!-- 변경데이터 -->

	</colgroup>
	<thead>
		<tr>
			<th>번호</th>
			<th>업무일시</th>
			<th>팀</th>
			<th>작업자</th>
			<th>고객명</th>
			<th>현재상태</th>
			<th>변경데이터</th>
			<th>업무내용</th>
		</tr>
	</thead>
	<tbody id="work_list">
	</tbody>
</table>

<!-- 페이징:S -->
<div class="area-pagination" id="pagination">
</div>
<!-- 페이징:E -->

<textarea id="tmpl_list" style="display:none">
	<tr>
		<td data-link="no">${\idx}</td>
		<td>${\work_datetime}</td>
		<td>${\team_name}</td>
		<td>${\reg_user_name}</td>
		<td><a href="javascript:;" onclick="window.open('/consulting/input/${\cst_seqno}')" class="link" >${\client_name}</a></td>
		<td><span class="label label-xs status-${\cst_status}">${\cst_status_txt}</span></td>
		<td>${\contents_cnt}건</td>
		<td class="left">${\contents}</td>
	</tr>
</textarea>

<textarea id="tmpl_pagination" style="display:none">
	<ul class="pagination">
		<li><a href="javascript:;" onclick="ConsultingWork.load(${\first})"><i class="fa fa-angle-double-left"></i></a></li>
		<li><a href="javascript:;" onclick="ConsultingWork.load(${\prev})"><i class="fa fa-angle-left"></i></a></li>
		{for p in block}
		<li class="{if p.equal==1} active {/if}"><a href="javascript:;" onclick="ConsultingWork.load(${\p.num})">${\p.num}</a></li>
		<!-- <li><a href="javascript:;">2</a></li> -->
		{/for}
		<li><a href="javascript:;" onclick="ConsultingWork.load(${\next})"><i class="fa fa-angle-right"></i></a></li>
		<li><a href="javascript:;" onclick="ConsultingWork.load(${\last})"><i class="fa fa-angle-double-right"></i></a></li>
	</ul>
</textarea>

<style>
/* 수술완료(99), 수술예정(98) */
.status-99,  .status-98 {background-color:#FF8000;}
/* 수술취소(90), 내원취소(50) */
.status-90, .status-50{}
/* 내원상담(52), 내원예약(51) */
.status-52, .status-51 {background-color: #03A9F4;}
/* 진행중(11), 예치금(13) */
.status-11, .status-13 {background-color: #8BC34A;}
/* 부재 */
.status-21, .status-22, .status-23 {background-color:#A1887F;}
/* 종료 */
.status-00, .status-09 {background-color:#414141;}
.table > tbody > tr.mydb > td {background-color:#FEFBF1;font-family:'NGB';color:#EC407A;}
</style>

<script language="javascript" src="/js/bootstrap.button.js"></script>
<script language="javascript" src="/js/template.js"></script>
<script type="text/javascript">
var ConsultingWork = {
	init: function() {
		var me = this;
		$('[data-role="search"]').on('change.search',function() {

			if(this.name == 'team_code') {
				me.loadUser(this.value);
			}

			ConsultingWork.load();
		});

		me.loadUser('{search.team_code}');
		HmisCommon.createDatepicker();
		this.load();
	},
	reset: function() {
		HmisCommon.formReset('FrmConsultingWorkSearch');
		$('#reg_user_id').hide();
		this.load(1);
	},
	setDate: function(s,e) {
		HmisCommon.setDate(s,e);
		this.load();
	},
	load: function(page) {
		HmisLoading.show('#work_list');

		var p = page || 1;
		var me = this;
		var search = $('#FrmConsultingWorkSearch').serialize();

		$.ajax({
			url:'/consulting/work_list_paging',
			data:{
				page:p,
				limit:15,
				search:search
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var tmpl = TrimPath.parseDOMTemplate('tmpl_list');
				var target = $('#work_list');
				target.empty();
				if(r.success) {
					var html = '';
					$.each(r.data.list, function(i,e){
						html += tmpl.process(e);
					});
					target.append(html);
				}
				else {
					target.append('<tr><td colspan="15">검색된 DB정보가 없습니다.</td></tr>');
				}

				var tmpl_page = TrimPath.parseDOMTemplate('tmpl_pagination');
				$('#pagination').empty().append(tmpl_page.process(r.data.paging));
				me.page = p;
				// me.createClick();
				$('#cnt_total').html(HmisCommon.numberFormat(r.data.count.total));
				$('#cnt_search').html(HmisCommon.numberFormat(r.data.count.search));
				$('#cnt_today').html(HmisCommon.numberFormat(r.data.count.today));

				$('[data-toggle="tooltip"]').tooltip();
			},
			complete: function() {
				HmisLoading.hide();
			}
		})
	},
	loadUser: function(team_code) {

		var sb_team = $('#reg_user_id');
		if(team_code == 'all' || !team_code) {
			sb_team.hide();
			return false;
		}
		sb_team.find('label:gt(0)').remove();

		$.ajax({
			url:'/manage/get_user_json',
			data:{
				dept_code:'90',
				team_code:team_code
			},
			dataType:'json',
			type:'POST',
			success: function(r){
				if(r.success){
					var reg_user_id = '{search.reg_user_id}';

					$.each(r.data, function(i,e){
						var checked = (reg_user_id==i)?'checked':'';
						var active = (reg_user_id==i)?'active':'';
						var label = '<label class="btn '+active+'" data-id="'+i+'"><input type="radio" name="reg_user_id" value="'+i+'"  onchange="ConsultingWork.load(1)"  '+checked+'/><span>'+e+'</span></label>'
						sb_team.append(label);
					});
					if(team_code == 'all' ) {
						sb_team.hide();
					}
					else {
						sb_team.show();
						if(sb_team.find('label.active').length<1) {
							sb_team.find('label:eq(0)').trigger('click');
						}
						else {
							sb_team.find('label[data-id="'+reg_user_id+'"]').trigger('click');
						}

					}
				}
			}
		});
	}
}

$(function() {
	ConsultingWork.init();
})
</script>
