<style>
.panel-body {
	height:500px;
}
textarea1 {border:none;}
#msg {
	position:absolute;
	top:78px;
	left:19px;
	width:191px;
	height:286px;
	border:none;
	background-color:#EFEFEF;
	overflow-y:auto;
}
.f-bold {font-family:'NGB';}
.sms_bg {background:url('/images/common/sms_bg.png') no-repeat;;height:440px;position:relative;}
.well {border-radius: 0px}
#receivers {padding:0px;}
#receivers li > span {display:inline-block;}
#receivers li {border-top:dotted 1px #E3E3E3;padding:5px 10px;position:relative;}
#receivers li:hover {background-color:#EFEFEF;}
#receivers li:first-child {border:none;}
span.d1 {width:138px;}
span.d2 {width:135px;}
span.d3 {width:135px;}
span.d4 {width:140px;}
#receivers li > div.close {position:absolute;right:5px;top:3px;cursor:pointer;color:#FF8000;}
.sms_count {position:absolute;right:20px;bottom:57px;color:#E3E3E3}
.sms_count > span {font-size:10px;}
#msg_type {background-color:transparent;border:none;color:#FFF;width:50px;font-size:10px;text-align: right}
</style>

<form id="FrmSMSPopup" onsubmit="return false">
<div style="margin:20px">
	<div class="btn-group hmis orange" data-toggle="buttons" id="tab">
		{@ cfg.label}
		<label class="btn"><input type="radio" name="no" value="{.no}" onchange="SMSPopup.load(this)" >{.sms_name}</label>
		{/}
	</div>

	<div class="clear" style="margin-top:20px"></div>

	<div style="width:227px;float:left">
		<div class="sms_bg">
			<textarea class="hmis validate[required]" data-errormessage-value-missing="발송할 메세지를 입력하세요."  name="msg" id="msg"></textarea>
			<div class="sms_count"><input type="text" name="msg_type" id="msg_type" value="SMS"> <span id="msg_bytes">0</span>/<span id="msg_max">90</span> Bytes</div>
		</div>


	</div>
	<div style="margin-left:247px">
		<div class="well">

			<input type="text" id="d1" class="required" placeholder="휴대폰번호" data-mask="mobile">
			<input type="text" id="d2" placeholder="이름">
			<input type="text" id="d3" placeholder="예약일" data-mask="date">
			<input type="text" id="d4" placeholder="예약시각" data-mask="time">
			<button type="button" class="btn btn-lightgray" onclick="SMSPopup.receiverAdd()"><i class="fa fa-1 fa-plus" style="color:#0091EA;vertical-align: -2px"></i></button>
		</div>

		<div class="f-bold" style="margin:10px 0px">수신리스트
			<div class="pull-right" style="font-family:NG;font-size:11px;">
				잔여발송건수 : {=number_format(cfg.remain)}건 <span class="split">|</span> 발송건수: <span id="count_receiver">0</span>건
			</div>
		</div>
		<ul class="well" id="receivers" style="height:310px;overflow-y:auto">
			{@ receiver}
			<li>
				<span class="d1" data-mobile="{.mobile}">{.mobile_txt}</span><span class="d2">{.name}</span><span class="d3">{.date}</span><span class="d4">{.time}</span><div class="close"><i class="fa fa-1 fa-trash" onclick="SMSPopup.receiverRemove(this)"></i></div>
			</li>
			{/}
		</ul>
		<div style="margin:5px 0px">
			<label class="hmis"><input type="checkbox" name="use_map" id="use_map" value="yes" class="hmis" /><span class="lbl"> 약도전송</span></label>
		</div>
		<div>
			<label class="hmis"><input type="checkbox" name="use_reserve" id="use_reserve"  value="yes" class="hmis" /><span class="lbl"> 예약</span></label>
			<span id="use_reserve_time" class="hide">
				<input type="text" class="datepicker validate[required]" data-errormessage-value-missing="예약발송날짜를 입력하세요." name="reserve_date" placeholder="발송날짜">
				<input type="text" class="validate[required]" placeholder="발송시각" name="reserve_time" data-errormessage-value-missing="예약발송시각을 입력하세요" data-mask="time2">
			</span>
		</div>
	</div>

</div>

<div style="text-align:center;padding:10px 0px">
	<button type="submit" class="btn btn-lg btn-theme"><i class="fa fa-send" style="vertical-align:-1px"></i> 발송하기</button>
	<button type="button" class="btn btn-lg" onclick="SMSPopup.log()"><i class="fa fa-align-justify" style="vertical-align:-1px"></i> 로그보기</button>
</div>
</form>


<div class="well" style="margin:10px">
	<span class="label label-error">도움말</span>
	<div class="dashed" style="margin:7px 0px"></div>
	<ul class="helper">
		<li>발신번호와 수신번호가 동일한 경우 정상적으로 발송되지 않습니다.</li>
		<li>예약발송은 현재기준 1시간 이후로 선택하는 경우에만 정상적으로 발송됩니다.</li>
		<li style="margin-top:10px"><b style="margin-right:10px">[이름]</b>예약자명(예:홍길동)</li>
		<li><b style="margin-right:10px">[예약일]</b> 예약날짜(예:0월 0일)</li>
		<li><b style="margin-right:10px">[예약시각]</b> 예약시각(예:00시 00분)</li>
	</ul>
</div>

<script language="javascript" src="/js/jquery.maskedinput.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.button.js"></script>
<script type="text/javascript">

var SMSPopup = {
	init: function() {
		var me = this;

		var option = $.extend({},validation_option, {
			display:'alert',
			showOneMessage:true,
			validationEventTrigger:'submit',

			onValidationComplete: function(form, status){
				if(status) me.send();
			}
		});
		$("#FrmSMSPopup").validationEngine('attach',option);


		HmisCommon.createDatepicker();

		$('input[data-mask="mobile"]').mask('019-9999-9999');
		$('input[data-mask="date"]').mask('99월 99일');
		$('input[data-mask="time"]').mask('99시 99분');
		$('input[data-mask="time2"]').mask('99:99:00');

		this.count();

		$('#use_reserve').on('click', function() {
			if($(this).is(':checked')) $('#use_reserve_time').removeClass('hide');
			else $('#use_reserve_time').addClass('hide');
		})

		$('#use_map').on('click', me.setBytes);

		$("#msg").on('keyup', function() {
			me.setBytes();
		});
	},
	count: function() {
		var count = $('#receivers > li').length;
		$('#count_receiver').text(count);
	},
	send: function() {
		var count = $('#receivers > li').length;
		if(count<1) {
			HmisAlert.alert('수신번호를 최소 1개이상 등록해주세요.');
			return false;
		}

		var msg = $("#msg").val();

		if (!msg) {
			HmisAlert.alert("메세지를 입력해주세요.");
			$("#msg").focus();
			return false;
		}

		//발신자목록
		var receiver = [];
		$('#receivers > li').each(function(i,e) {
			receiver.push({
				mobile:$(e).find('span.d1').data('mobile'),
				name:$(e).find('span.d2').text(),
				date:$(e).find('span.d3').text(),
				time:$(e).find('span.d4').text()
			})
		});

		//발송가능건수 체크
		var remain = {cfg.remain};
		if(receiver.length > remain) {
			HmisAlert.alert('발송가능건수를 초과하였습니다.');
			return false;
		}

		HmisAlert.confirm('발송하시겠습니까?', function(r){
			if(!r) return false;

			var formdata = $('#FrmSMSPopup').serializeArray();
			formdata.push({name:'receiver', value:JSON.stringify(receiver)});

			$.ajax({
				type: "POST",
				url: "/sms/send_new",
				data: formdata,
				dataType:'json',
				success: function(r){
					HmisAlert.alert(r.msg, function() {
						if(r.success) {
							SMSPopup.log();
						}
					});

				}
			});

			return false;
		});
	},
	log: function() {
		document.location.href="/sms/popup_log";
	},
	preview: function() {
		HmisAlert.alert('열심히 개발중입니다..');
	},
	receiverAdd: function() {
		var target = $('#receivers');
		var li = $('<li />');

		var d1 = $('#d1').val(); //휴대폰번호
		if(!d1) {
			HmisAlert.alert('휴대폰 번호는 반드시 입력하세요.');
			return false;
		}

		var d2 = $('#d2').val(); //이름
		var d3 = $('#d3').val(); //예약일
		var d4 = $('#d4').val(); //예약시각

		li.append('<span class="d1" data-mobile="'+d1+'">'+d1+'</d1>');
		li.append('<span class="d2">'+d2+'</d1>');
		li.append('<span class="d3">'+d3+'</d1>');
		li.append('<span class="d4">'+d4+'</d1>');
		li.append('<div class="close"><i class="fa fa-1 fa-trash" onclick="SMSPopup.receiverRemove(this)"></i></div>');
		target.append(li);
		this.count();

	},
	receiverRemove: function(e) {
		var li = $(e).closest('li');
		li.remove();
		this.count();
	},
	load: function(e) {
		var me = this;
		var sms_no = e.value;
		$.ajax({
			url:'/settings_proc/get_smsmsg',
			data:{
				no:sms_no
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				$('#msg').val(r.data.msg);
				if(r.data.img_use == 'Y') {
					$('#use_map').prop('checked',true);
					//$('#use_map').attr('disabled', true)
				}
				else {
					$('#use_map').prop('checked',false);
					//$('#use_map').removeAttr('disabled');
				}

				me.setBytes();
			}
		})
	},
	setBytes: function() {
		var target = $('#msg');
		var value = target.val();
		var length = target.val().length;

		if(value == null || length == 0) return 0;

		var i, size = 0;
		var char_code, chr = null;
		for( i = 0 ; i < length ; i++ ) {
			chr = value.charAt(i);
			char_code = chr.charCodeAt(0);
			if (char_code <= 0x00007F) size += 1; else
			if (char_code <= 0x0007FF) size += 2; else
			if (char_code <= 0x00FFFF) size += 3;
			else size += 4;
		}

		$('#msg_type').val('SMS');
		$('#msg_max').text('90');
		if (size > 90 || $('#use_map').is(':checked')) {
			$('#msg_type').val('MMS');
			$('#msg_max').html('2000');
		}

		if (size >= 2000) {
			HmisAlert.alert('내용을 2000bytes 이상 작성할 수 없습니다.');
			return false;
		}
		$('#msg_bytes').html(size);
	}
}


$(function() {
	SMSPopup.init();
})


</script>
