<form id="FrmDBInput">
<input type="hidden" name="hst_code" id="hst_code" value="{layout.login.info.ss_hst_code}">
<input type="hidden" name="biz_id" id="biz_id" value="{layout.login.info.ss_biz_id}">
<input type="hidden" name="assign_type" id="assign_type" value="{assign_type}"><!-- 분배유형(F:직접분배, O:자동분배) -->
<input type="hidden" name="type" id="type" value="{type}">

<table class="table table-bordered table-form">
	<colgroup>
		<col style="width:120px" />
		<col />
		<col style="width:120px" />
		<col />
	</colgroup>
	<tbody>
		<tr>
			<th>사업장</th>
			<td colspan="3"><div class="minheight">{layout.login.info.ss_biz_name}</div></td>
		</tr>
		<tr>
			<th>이름</th>
			<td colspan="3"><input type="text" name="name" class="validate[required] required" data-errormessage-value-missing="이름을 입력하세요." /></td>
		</tr>
		<tr>
			<th>생년월일</th>
			<td>
				<input type="text" name="birth" class="datepicker lg" data-mask="date" />
			</td>
			<th>성별</th>
			<td>
				<label class="hmis"><input type="radio" name="sex" value="F" class="hmis"><span class="lbl"> 여</span></label>
				<label class="hmis"><input type="radio" name="sex" value="M" class="hmis"><span class="lbl"> 남</span></label>
			</td>
		</tr>
		<tr>
			<th>연락처</th>
			<td><input type="text" size="25" name="tel" class="validate[groupRequired[contacts]] required"  data-errormessage-value-missing="연락처나 메신저를 입력하세요." /></td>
			<th>메신저</th>
			<td><input type="text" size="30" name="messenger" class="validate[groupRequired[contacts]] required"  data-errormessage-value-missing="연락처나 메신저를 입력하세요." /></td>
		</tr>
		<tr>
			<th>이메일</th>
			<td colspan="3"><input type="text" size="40" name="email" class="validate[custom[email]]" /></td>
		</tr>
		<tr>
			<th>상담항목</th>
			<td>
				<select name="category" id="category">
					<option value="">::상담항목선택::</option>
					{@ cfg.category}
					<option value="{.key_}">{.value_}</option>
					{/}
				</select>
			</td>
			<th>상담가능시간</th>
			<td>
				<select name="call_time">
					<option value="">:: 선택 ::</option>
					<option>오전9시-10시</option>
					<option>오전10시-11시</option>
					<option>오전11시-12시</option>
					<option>오후12시-1시</option>
					<option>오후1시-2시</option>
					<option>오후2시-3시</option>
					<option>오후3시-4시</option>
					<option>오후4시-5시</option>
					<option>오후5시-6시</option>
					<option>오후6시-7시</option>
					<option>오전</option>
					<option>오후</option>
					<option>상시</option>
				</select>
			</td>
		</tr>

		<tr>
			<th>유입경로</th>
			<td>
				<select name="path" id="path" class="validate[required] required" data-ui="change" data-errormessage-value-missing="유입경로를 선택하세요.">
					<option value="">::유입경로 선택::{mode}</option>
					{@ cfg.path}
					<option value="{.key_}">{.value_}</option>
					{/}
				</select>

				{? mode == 'DIRECT'}
				<input type="hidden" name="team_code" id="team_code" value="{layout.login.info.ss_team_code}">
				{:}
				<span data-ui-group="path" data-ui-value="Y" style="display: none;">
					<select name="team_code" class="validate[required] required">
						<option value="">::팀 선택::</option>
						{@ cfg.team}
						<option value="{.key_}">{.value_}</option>
						{/}
					</select>
				</span>
				{/}
			</td>
			<th>미디어</th>
			<td>
				<select name="media" id="media">
					<option value="">::미디어선택::</option>
					{@ cfg.media}
					<option value="{.value_}">{.value_}</option>
					{/}
				</select>
			</td>
		</tr>

		<tr>
			<th>메모</th>
			<td colspan="3"><input type="text" name="memo" class="full" /></td>
		</tr>
		<tr data-ui-group="path" data-ui-value="C P O"  style="display: none;">
			<th>실시간 상담</th>
			<td colspan="3">
				<textarea name="realtime_memo" class="hmis" style="height:70px"></textarea>
			</td>
		</tr>
	</tbody>
</table>

<div class="area-button">
	<button type="button" class="btn btn-flat-orange btn-lg" onclick="DBInput.duplicate()">고객중복체크</button>
	<button type="submit" class="btn btn-theme btn-lg">저장</button>
	<button type="button" class="btn btn-gray btn-lg modal-close">닫기</button>
</div>
</form>

<script language="javascript" src="/js/jquery.maskedinput.min.js"></script>
<script type="text/javascript">
var DBInput = {
	form_id:'FrmDBInput',
	init: function() {
		var me = this;
		this.frm = $("#"+this.form_id);
		var option = $.extend({},validation_option, {
			onValidationComplete: function(form, status){
				if(status) me.save();
			}
		});

		this.frm.validationEngine('attach',option);

		$('input[data-mask="date"]').mask('9999-99-99');

		$.each($('[data-ui]'), function(i,e) {
			me.setUI(this.name);
			var evt = $(e).data('ui');
			$(this).on(evt,function() {
				me.setUI(this.name);
			});
		});
	},
	setUI: function(name) {
		this.frm.validationEngine('hide');
		var v = HmisCommon.getValue(this.frm.find('[name="'+name+'"]'));
		var group = $('[data-ui-group="'+name+'"]');
		group.css('display','none');
		group.filter('[data-ui-value~="'+v+'"]').css('display','');
		if(name == 'path') {
			if(v == 'Y') $('#assign_type').val('F');
			else $('#assign_type').val('{assign_type}');
		}
	},
	save: function() {
		// 20170320 kruddo : 유입경로가 '온라인'이면 미디어 강제 입력 사항, '온라인'이 아니면 미디어는 공백처리
		if($('#path').val() == "L"){
			if($('#media').val() == ""){
				HmisAlert.alert('유입경로가 온라인이면 미디어를 선택 해 주세요.');
				return;
			}
		}
		else{
			$('#media option:eq(0)').attr("selected", "selected");
		}
		
		// 20170320 kruddo : 유입경로가 '온라인'이면 미디어 강제 입력 사항, '온라인'이 아니면 미디어는 공백처리

		var formdata = this.frm.serialize();
		$.ajax({
			url : "/db_proc/add",
			data : formdata,
			dataType:'json',
			type : "POST",
			success : function(r) {
				if(r.success){
					HmisAlert.alert("신규DB가 등록되었습니다.", function() {
						$('.modal-close').trigger('click');
					});

				}
				else {
					HmisAlert.alert('잠시 후에 다시 시도해주세요.');
				}

			}
		});
	},
	duplicate: function() {
		var title = '고객검색';
		var modal = new HmisModal('dbsearch', {width:500, top:200});
		modal.open(title,'/db/search');
	}
}

$(function() {
	DBInput.init();
})

</script>
