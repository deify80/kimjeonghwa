<h3 class="area-title">수납내역 검색 <span class="helper">(수납일 기준)</span></h3>
<form id="FrmPatientPaySearch" onsubmit="PaidList.load(1); return false">
<input type="hidden" name="group_code" value="<?=$cfg['group']?>" />
<input type="hidden" name="limit" id="cnt_search" value="0">
<input type="hidden" name="page" value="1">
<table class="table table-bordered table-form">
	<colgroup>
		<col style="width:120px" />
		<col />
		<col style="width:120px" />
		<col />
	</colgroup>
	<tbody>
		{? auth.paid_all}
		<tr>
			<th>수납기간</th>
			<td colspan="3">
				<input type="text" class="datepicker lg" name="date_s" id="sdate_s" value="{=date('Y-m-d')}"> ~ <input type="text" class="datepicker lg" name="date_e" value="{=date('Y-m-d')}" id="sdate_e">
				<ul class="btn-group btn-group-xs">
					<li onclick="PaidList.setDate('{=date('Y-m-d')}','{=date('Y-m-d')}');"><a href="javascript:;">오늘</a></li>
					<li onclick="PaidList.setDate('{cfg.date.weekday_db}','{=date('Y-m-d')}');"><a href="javascript:;">이번주</a></li>
					<li onclick="PaidList.setDate('{cfg.date.cur_month}','{=date('Y-m-d')}');"><a href="javascript:;">이번달</a></li>
					<li onclick="PaidList.setDate('{cfg.date.yesterday}','{=cfg.date.yesterday}');"><a href="javascript:;">어제</a></li>
					<li onclick="PaidList.setDate('{cfg.date.pre_week_start_db}','{cfg.date.pre_week_end_db}');"><a href="javascript:;">지난주</a></li>
					<li onclick="PaidList.setDate('{cfg.date.pre_month_start}','{cfg.date.pre_month_end}');"><a href="javascript:;">지난달</a></li>
				</ul>
			</td>
		</tr>
		{/}
		<tr>
			<th>검색어</th>
			<td>
				<input type="text" name="word" class="full" placeholder="환자명 or 휴대폰번호" >
			</td>
			<th>수납구분</th>
			<td>
				<div class="btn-group hmis blue" data-toggle="buttons">
					<label class="btn active"><input type="radio" name="pay_type" value="all" checked />전체</label>
					<label class="btn"><input type="radio" name="pay_type" value="paid" />입금</label>
					<label class="btn"><input type="radio" name="pay_type" value="refund" />환불</label>
				</div>
			</td>
		</tr>
		<tr>
			
			<th>담당의사</th>
			<td>
				<select name="doctor_id">
					<option value="">::전체::</option>
					{@ cfg.doctor}
					<option value="{.key_}">{.value_}</option>
					{/}
				</select>
			</td>
			<th>담당실장</th>
			<td>
				<!-- 20170306 kruddo : 담당의사->전체, 팀->전체. 팀 변경시 팀원 목록 안 보이게 -->
				<!-- <select name="manager_team_code" id="scsb_team" onchange="HmisCommon.loadUser(this.value, '', 'scsb')"> -->
				<select name="manager_team_code" id="scsb_team">
					<option value="all">::전체::</option>
					{@ cfg.team}
					<option value="{.key_}">{.value_}</option>
					{/}
				</select>
				<!-- <select name="manager_id" id="scsb_user" style="display:none">
					<option value="all">::팀원::</option>
				</select> -->
			</td>

		</tr>
	</tbody>
</table>

<div class="area-button">
	<button type="submit" class="btn btn-lg btn-theme" ><i class="fa fa-search"></i> 검색</button>
	<button type="button" class="btn btn-lg btn-gray" onclick="PaidList.reset()">처음으로</button>
</div>
</form>

<div class="dashed"></div>
<div class="row rel" style="margin-top:10px">
	<div class="main-box infographic-box colored" style="background-color: #29B6F6">
		<div class="headline"> <i class="fa fa-krw"></i> 총수납액</div>
		<span class="value" id="amount_paid"></span>
	</div>

	<div class="main-box infographic-box colored" style="background-color: #C3C3C3;" >
		<div class="headline"> <i class="fa fa-money"></i>  현금</div>
		<span class="value" id="amount_paid_cash"></span>
	</div>

	<div class="main-box infographic-box colored" style="background-color: #C3C3C3;">
		<div class="headline"> <i class="fa fa-credit-card"></i> 카드</div>
		<span class="value" id="amount_paid_card"></span>
	</div>

	<div class="main-box infographic-box colored" style="background-color: #C3C3C3;">
		<div class="headline"> <i class="fa fa-exchange"></i> 계좌이체</div>
		<span class="value" id="amount_paid_bank"></span>
	</div>

	<div class="main-box infographic-box colored" style="background-color:#80CBC4">
		<div class="headline"> <i class="fa fa-calculator"></i> 현금영수증발급액</div>
		<span class="value" id="amount_receipt"></span>
	</div>

	<!--{*
	<div class="main-box infographic-box colored" style="background-color:#FF5722">
		<div class="headline"> <i class="fa fa-calculator"></i> 환불액</div>
		<span class="value" id="amount_refund"></span>
	</div>
	*}-->


	{? auth.paid_excel}
	<div class="abs" style="right:0px;;bottom:10px"><button type="button" class="btn btn-lightgray" onclick="PaidList.excel()"><i class="fa fa-1 fa-file-excel-o" style="color:#0091EA"></i> 엑셀다운로드</button></div>
	{/}
</div>


<table class="table table-bordered table-list table-striped table-hover">
	<colgroup>
		<col style="width:60px" /><!-- 번호 -->
		<col style="width:100px" /><!-- 수납일자 -->
		<col style="width:60px" /><!-- 수납구분 -->
		<col style="width:60px" /><!-- 구분 -->
		<col style="width:130px" /><!-- 환자명 -->
		<col style="width:120px" /><!-- 연락처 -->
		<col style="width:100px" /><!-- 수납자 -->
		<col style="width:100px" /><!-- 담당실장 -->
		<col style="width:100px" /><!-- 현금영수증 -->
		<!-- <col style="width:100px" /> --><!-- 총매출 -->
		<col style="width:100px" /><!-- 총수납액 -->
		<col style="width:100px" /><!-- 현금 -->
		<col style="width:100px" /><!-- 카드 -->
		<col style="width:100px" /><!-- 계좌이체 -->
		<!-- <col style="width:100px" /> --><!-- 미수금 -->
		<!-- <col style="width:100px" /> --><!-- 재료비 -->
		<col ><!-- 특이사항 -->
	</colgroup>
	<thead>
		<tr>
			<th rowspan="2">번호</th>
			<th rowspan="2">수납일자</th>
			<th rowspan="2">수납구분</th>
			<th rowspan="2">구분</th>
			<th rowspan="2">환자명</th>
			<th rowspan="2">연락처</th>
			<th rowspan="2">수납자</th>
			<th rowspan="2">담당실장</th>

			<th rowspan="2">현금영수증</th>
			<!-- <th rowspan="2">총매출</th> -->
			<th colspan="4">수납</th>
			<!-- <th rowspan="2">미수금</th> -->
			<!-- <th rowspan="2">재료비</th> -->
			<th rowspan="2">특이사항</th>
		</tr>
		<tr>
			<th>총수납액</th>
			<th>현금</th>
			<th>카드</th>
			<th>계좌이체</th>
		</tr>
	</thead>
	<tbody id="paid_list">
	</tbody>
</table>


<!-- 페이징:S -->
<div class="area-pagination" id="pagination">
</div>
<!-- 페이징:E -->

<textarea id="tmpl_list" style="display:none">
	<tr >
		<td>${\idx}</td>
		<td>${\date_paid}</td>
		<td>{if pay_type=='paid'} <span class="label label-xs label-theme">입금</span> {\else} <span class="label label-xs label-error">환불</span> {/if}</td>
		<td>{if pay_type=='paid'} ${\sales_type} {\else} - {/if}</td>
		<td><a href="/patient/info/${\patient_no}" target="_blank" class="link">${\name} {if sex == 'F'} <i class="fa fa-1 fa-female f-pink"></i> {\else} <i class="fa fa-1 fa-male f-blue"></i> {/if}</a></td>
		<td>${\mobile}</td>
		<td>${\acceptor_name}</td>
		<td>${\manager_name}</td>

		<td>${\receipt_type}</td>
		{if pay_type == 'paid'}
		<td>
			<a href="javascript:;" onclick="PaidList.modify('${\patient_no}','${\project_no}','${\no}')" class="link">
			<span class="f-blue">+ ${HmisCommon.numberFormat(amount_paid)}</span>
			</a>
		</td>
		<td>${HmisCommon.numberFormat(amount_paid_cash)}</td>
		<td>${HmisCommon.numberFormat(amount_paid_card)}</td>
		<td>${HmisCommon.numberFormat(amount_paid_bank)}</td>
		{\else}
		<td>
			<a href="javascript:;" onclick="PaidList.modify('${\patient_no}','${\project_no}','${\no}')" class="link"><span class="f-error">- ${HmisCommon.numberFormat(amount_refund)}</span>
			</a>
		</td>
		<td>{if amount_refund_cash>0}<span class="f-error">-${HmisCommon.numberFormat(amount_refund_cash)}</span>{\else}0{/if}</td>
		<td>{if amount_refund_card>0}<span class="f-error">-${HmisCommon.numberFormat(amount_refund_card)}</span>{\else}0{/if}</td>
		<td>{if amount_refund_bank>0}<span class="f-error">-${HmisCommon.numberFormat(amount_refund_bank)}</span>{\else}0{/if}</td>
		{/if}
		<td class="left">${\comment}</td>
	</tr>
</textarea>

<textarea id="tmpl_pagination" style="display:none">
	<ul class="pagination">
		<li><a href="javascript:;" onclick="PaidList.load(${\first})"><i class="fa fa-angle-double-left"></i></a></li>
		<li><a href="javascript:;" onclick="PaidList.load(${\prev})"><i class="fa fa-angle-left"></i></a></li>
		{for p in block}
		<li class="{if p.equal==1} active {/if}"><a href="javascript:;" onclick="PaidList.load(${\p.num})">${\p.num}</a></li>
		<!-- <li><a href="javascript:;">2</a></li> -->
		{/for}
		<li><a href="javascript:;" onclick="PaidList.load(${\next})"><i class="fa fa-angle-right"></i></a></li>
		<li><a href="javascript:;" onclick="PaidList.load(${\last})"><i class="fa fa-angle-double-right"></i></a></li>
	</ul>
</textarea>



<script language="javascript" src="/js/template.js"></script>
<script type="text/javascript" src="/js/bootstrap.button.js"></script>
<script language="javascript" src="/js/Hmis.treat.js"></script>
<script type="text/javascript">
var PaidList = {
	page:1,
	init: function() {
		this.load(1);
		$('input[name="pay_type"], #scsb_team, #scsb_user, select[name="doctor_id"]').on('change', function() {
			PaidList.load(1);
		});

		HmisCommon.createDatepicker();
	},
	setDate: function(s,e, target_s, target_e) {
		HmisCommon.setDate(s,e,target_s, target_e);
		this.load(1);
	},
	reload: function() {
		PaidList.load(PaidList.page);
	},
	excel: function() {
		var search = $('#FrmPatientPaySearch').serialize();
		document.location.href = '/pay/paid_excel?'+search;
	},
	load: function(page) {
		var p = page || 1;
		var me = this;
		var search = $('#FrmPatientPaySearch').serialize();

		$.ajax({
			url:'/pay/paid_list_paging',
			data:{
				page:p,
				limit:15,
				search:search
			},
			dataType:'json',
			type:'POST',
			success: function(r) {

				var tmpl = TrimPath.parseDOMTemplate('tmpl_list');
				var target = $('#paid_list');
				target.empty();
				if(r.success) {
					var html = '';
					$.each(r.data.list, function(i,e){
						html += tmpl.process(e);
					});
					target.append(html);

					$.each(r.data.sum, function(i,e){
						$('#amount_'+i).html(HmisCommon.numberFormat(e));
					});
				}
				else {
					target.append('<tr><td colspan="14">검색된 수납내역이 없습니다.</td></tr>');
					$.each($('span[id^="amount_"]'), function(i,e){
						$(this).text('0');
					})
				}

				var tmpl_page = TrimPath.parseDOMTemplate('tmpl_pagination');
				$('#pagination').empty().append(tmpl_page.process(r.data.paging));

				me.page = p;

				$('#cnt_search').val(r.data.count.search);
				$('[data-toggle="tooltip"]').tooltip();
			}
		})
	},
	reset: function(){
		HmisCommon.formReset('FrmPatientPaySearch');
		this.load();
	},
	modify: function(patient_no, project_no, no) {
		var title = '수납내역 수정';
		var modal = new HmisModal('payinput', {width:1200, top:200});
		modal.callback = this.reload;
		modal.open(title,'/patient/info_widget_pay_input',{patient_no:patient_no, project_no:project_no, no:no});
	}
}

$(function() {
	PaidList.init();
})
</script>
