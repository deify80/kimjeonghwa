<div style="position:relative">
<form id="FrmReserveInputSearch" onsubmit="return false">
<input type="hidden" name="group_code" value="<?=$rs['group_code']?>" />
<table class="table table-bordered table-form">
	<colgroup>
		<col width="120px">
		<col>

	</colgroup>
	<tbody>
		<tr>
			<th>환자 검색 <i class="fa fa-info-circle fa-1 f-info" data-role="tooltip" title="기존 환자리스트에서 검색합니다."></i> </th>
			<td>
				<div>
					<input type="search" name="patient_name" id="search_reserve_patient" style="width:350px" autocomplete="off" placeholder="환자명 or 연락처 "/> 
					<button type="submit" class="btn btn-flat-blue"><i class="fa fa-search fa-1"></i> 검색</button>
					<button type="button" class="btn btn-gray"  onclick="ReserveInput.reset()"><i class="fa fa-refresh fa-1"></i>처음으로</button>
				</div>
			</td>
		</tr>
	</tbody>
</table>
</form>
<div class="dashed" style="margin:10px 0px"></div>

<form id="FrmReserveInput" onsubmit="return false">
<input type="hidden" name="patient_no" value="" /> <!-- 환자PK -->
<!-- 환자정보:S -->
<h3 class="area-title">환자정보 
	<div class="button-box">
		Chart No. <span id="chart_no" class="f-error">신규환자</span>
	</div>
	
</h3>
<table class="table table-bordered table-form">
	<colgroup>
		<col width="120px">
		<col>
		<col width="120px">
		<col>
		<col width="120px">
		<col>
	</colgroup>
	<tbody>
		<tr>
			<th>이름</th>
			<td><input type="text" name="name" class="validate[required] full required" value="<?=$rs['name']?>" /></td>
			<th>주민등록번호</th>
			<td><input type="text" name="jumin" class="full" data-mask="jumin" value="<?=$rs['jumin']?>" /></td>
			<th>생년월일</th>
			<td>
				<input type="text" name="birth" class="" value="<?=$rs['birth']?>"  data-mask="date" style="width:110px" />
			</td>
		</tr>
		<tr>
			<th>성별</th>
			<td>
				<label class="hmis"><input type="radio" name="sex" value="M" class="hmis" <?=($rs['sex']=='M')?'checked':''?> /><span class="lbl"> 남</span></label>
				<label class="hmis"><input type="radio" name="sex" value="F" class="hmis" <?=($rs['sex']=='F')?'checked':''?> /><span class="lbl"> 여</span></label>
			</td>
			<th>휴대폰번호</th>
			<td><input type="text" name="mobile" value="<?=$rs['mobile']?>"  style="width:110px" class="validate[groupRequired[contacts]] required" data-mask="mobile"  data-errormessage-value-missing="휴대폰번호와 메신저 중 한개는 반드시 입력하세요."/> <button type="button" class="btn btn-flat-lightgray btn-onlyicon" onclick="PatientInput.checkDuplicate('mobile')" data-role="tooltip" title="중복확인"><i class="fa fa-check fa-1"></i></button></td>
			<th>유선전화</th>
			<td><input type="text" name="tel" value="<?=$rs['tel']?>" class="full" /></td>
		</tr>
		<tr>
			<th>메신저</th>
			<td><input type="text" name="messenger" value="<?=$rs['messenger']?>" style="width:110px" class="validate[groupRequired[contacts]] required"  data-errormessage-value-missing="휴대폰번호와 메신저 중 한개는 반드시 입력하세요." data-errormessage-pattern-mismatch="메신저 중복체크가 필요합니다."  /> <button type="button" class="btn btn-flat-lightgray btn-onlyicon" onclick="PatientInput.checkDuplicate('messenger')" data-role="tooltip" title="중복확인"><i class="fa fa-check fa-1"></i></button></td>
			<th>이메일</th>
			<td colspan="3"><input type="text" name="email" value="<?=$rs['email']?>" class="validate[custom[email]] full" autocomplete="off" /></td>
		</tr>
		<tr>
			<th rowspan="2">주소</th>
			<td colspan="5">
				<input type="text" name="zipcode" class="" value="<?=$rs['zipcode']?>" placeholder="우편번호" /> <button type="button" class="btn btn-flat-lightgray btn-onlyicon"><i class="fa fa-search fa-1"></i></button>
				<input type="text" name="address" value="<?=$rs['address']?>" style="width:500px" >
			</td>
		</tr>
		<tr>
			<td colspan="5">
				<input type="text" name="address_detail" value="<?=$rs['address_detail']?>" class="full" placeholder="상세주소">
			</td>
		<tr>
			<th>직업</th>
			<td>
				<select name="job_code">
					<option value="">::직업::</option>
					<? foreach($cfg['job'] as $job_code=>$job) {?>
					<option value="<?=$job_code?>" <?=($rs['job_code']==$job_code)?'selected':''?>><?=$job?></option>
					<? } ?>
				</select>
			</td>
			<th>직장명</th>
			<td><input type="text" name="company" class="full" value="<?=$rs['company']?>" /></td>
			<th>유입경로</th>
			<td>
				<select name="path_code">
					<option value="">::유입경로::</option>
					<? foreach($cfg['path'] as $path_code=>$path) {?>
					<option value="<?=$path_code?>" <?=($rs['path_code']==$path_code)?'selected':''?>><?=$path?></option>
					<? } ?>
				</select>
			</td>
		</tr>
		<tr>
			<th>담당의사</th>
			<td>
				<select name="doctor_id">
					<option value="">::담당의사::</option>
					<? foreach($cfg['doctor'] as $doctor_id=>$doctor_name) {?>
					<option value="<?=$doctor_id?>" <?=($rs['doctor_id']==$doctor_id)?'selected':''?>><?=$doctor_name?></option>
					<? } ?>
				</select>
			</td>
			<th>담당자 <?=$rs['manager_team_code']?></th>
			<td>
				<select name="manager_team_code" id="sb_team" onchange="ReserveInput.loadUser(this.value)">
					<option value="">::팀::</option>
					<? foreach($cfg['team'] as $team_code=>$team_name) {?>
					<option value="<?=$team_code?>" <?=($rs['manager_team_code']==$team_code)?'selected':''?>><?=$team_name?></option>
					<? } ?>
				</select>
				<select name="manager_id" id="sb_user" style="display:none">
					<option value="">::팀원::</option>
				</select>
			</td>
			<th>소개자</th>
			<td>
				<input type="text" class="" style="width:100px" />
				<button type="button" class="btn btn-flat-lightgray btn-onlyicon"><i class="fa fa-search fa-1"></i></button>
			</td>
		</tr>
		<tr>
			<th>선택사항</th>
			<td colspan="5">
				<label class="hmis"><input type="checkbox" name="agree_privacy" value="Y" class="hmis" <?=($rs['agree_privacy']=='Y')?'checked':''?> /><span class="lbl"> 개인정보수집 및 이용동의</span></label>
				<label class="hmis"><input type="checkbox" name="agree_sms" value="Y" class="hmis" <?=($rs['agree_sms']=='Y')?'checked':''?> /><span class="lbl"> SMS수신동의</span></label>
				<label class="hmis"><input type="checkbox" name="agree_email" value="Y" class="hmis" <?=($rs['agree_email']=='Y')?'checked':''?> /><span class="lbl"> 이메일수신동의</span></label>
			</td>
		</tr>
		<tr>
			<th>특이사항</th>
			<td colspan="5">
				<textarea type="text" name="comment" class="hmis"><?=$rs['comment']?></textarea>
			</td>
		</tr>
	</tbody>
</table>
<!-- 환자정보:E -->

<!-- 예약정보:S -->
<h3>예약정보</h3>
<table class="table table-bordered table-form">
	<colgroup>
		<col width="120px">
		<col>
		<col width="120px">
		<col>
		<col width="120px">
		<col>
	</colgroup>
	<tbody>
		<tr>
			<th>예약유형</th>
			<td>
				<select name="reserve[type]" class="validate[required] required">
					<option value="">::예약유형::</option>
					<? foreach($cfg['type'] as $type_code => $type_name) {?>
					<option value="<?=$type_code?>" <?=($rs['type']==$type_code)?'selected':''?> ><?=$type_name?></option>
					<? } ?> 
				</select>
			</td>
			<th>예약날짜</th>
			<td><input type="text" name="reserve[date]" value="<?=$rs['date']?>" class="datepicker full required" readonly/></td>
			<th>예약시간</th>
			<td>
				<select name="reserve_time_start" class="validate[required] required">
					<? for($st=$cfg['time']['start']; $st<$cfg['time']['end'];$st+=1800){?>
					<option value="<?=date('H:i', $st)?>"  <?=($st==$rs['time_start'])?'selected':''?>><?=date('H:i', $st)?></option>
					<? } ?>
				</select>
				~ 
				<select name="reserve_time_end" class="validate[required] required">
					<? for($st=$cfg['time']['start']+1800; $st<=$cfg['time']['end'];$st+=1800){?>
					<option value="<?=date('H:i', $st)?>"  <?=($st==$rs['time_end'])?'selected':''?>><?=date('H:i', $st)?></option>
					<? } ?>
				</select>
			</td>
		</tr>
		<tr>
			<th>접수자</th> <!-- 코디팀 -->
			<td>
				<select name="reserve[acceptor_id]">
					<option value="">::접수자::</option>
					<? foreach($cfg['acceptor'] as $user_id => $user_name) {?>
					<option value="<?=$user_id?>" <?=($rs['acceptor_id']==$user_id)?'selected':''?> ><?=$user_name?></option>
					<? } ?> 
				</select>
			</td>
			<th>담당자</th> <!-- 상담팀 -->
			<td>
				<select name="reserve[manager_team_code]" id="reserve_team" onchange="ReserveInput.loadUser(this.value, '', 'reserve')">
					<option value="">::팀::</option>
					<? foreach($cfg['team'] as $team_code=>$team_name) {?>
					<option value="<?=$team_code?>" <?=($rs['manager_team_code']==$team_code)?'selected':''?>><?=$team_name?></option>
					<? } ?>
				</select>
				<select name="reserve[manager_id]" id="reserve_user" style="display:none">
					<option value="">::팀원::</option>
				</select>
			</td>
			<th>피부관리사</th> <!-- 피부팀 -->
			<td>
				<select name="reserve[skincare_id]">
					<option value="">::피부관리사::</option>
					<? foreach($cfg['skincare'] as $user_id => $user_name) {?>
					<option value="<?=$user_id?>" <?=($rs['skincare_id']==$user_id)?'selected':''?> ><?=$user_name?></option>
					<? } ?> 
				</select>
			</td>
		</tr>
		<tr>
			<th>초/재진</th>
			<td>
				<label class="hmis"><input type="radio" name="reserve[visit]" value="first" class="hmis" <?=($rs['visit']=='first')?'checked':''?> /><span class="lbl"> 초진</span></label>
				<label class="hmis"><input type="radio" name="reserve[visit]" value="second" class="hmis" <?=($rs['visit']=='second')?'checked':''?> /><span class="lbl"> 재진</span></label>
			</td>
			<th>예약상태</th>
			<td>
				<select name="reserve[status]" class="validate[required] required">
					<option value="">::예약상태::</option>
					<? foreach ($cfg['status'] as $status) {?>
					<option value="<?=$status['code']?>" style="color:<?=$status['etc']?>;"><?=$status['title']?></option>
					<? } ?>
				</select>
			</td>		
			<th>담당의사</th>
			<td>
				<select name="reserve[doctor_id]">
					<option value="">::담당의사::</option>
					<? foreach($cfg['doctor'] as $doctor_id=>$doctor_name) {?>
					<option value="<?=$doctor_id?>" <?=($rs['doctor_id']==$doctor_id)?'selected':''?>><?=$doctor_name?></option>
					<? } ?>
				</select>
			</td>			
		</tr>
		<tr>
			<th rowspan="2">진료부위</th>
			<td colspan="5">
				<select name="treat_region" id="sb_treat_region" onchange="ReserveInput.loadTreatItem(this.value)">
					<option value="">::진료부위::</option>
					<? foreach($cfg['treat_region'] as $region_code=>$region_name) {?>
					<option value="<?=$region_code?>" <?=($rs['treat_region_code']==$region_code)?'selected':''?>><?=$region_name?></option>
					<? } ?>
				</select>
				<select name="treat_item" id="sb_treat_item" style="display:none" onchange="ReserveInput.addTreat()">
					<option value="">::진료항목::</option>
				</select>
			</td>
		</tr>
		<tr>
			<td colspan="5">
				<div id="treat_null" style="padding:6px 0px 7px;">진료항목을 선택하세요.</div>
				<div id="treat_list"></div>
			</td>
		</tr>
		<tr>
			<th>예약특이사항</th>
			<td colspan="5">
				<textarea name="" class="hmis"></textarea>
			</td>
		</tr>
	</tbody>
</table>
<!-- 예약정보:E -->

<div class="area-button">
	<button type="submit" class="btn btn-theme btn-lg">저장</button>
	<button type="button" class="btn btn-gray btn-lg modal-close">닫기</button>
</div>
</form>
</div>


<script language="javascript" src="/js/jquery.maskedinput.min.js"></script>
<script type="text/javascript">
var ReserveInput = {
	init: function() {
		$('input[data-mask="jumin"]').mask('999999-9999999');
		$('input[data-mask="mobile"]').mask('019-9999-9999');
		$('input[data-mask="date"]').mask('9999/99/99');

		HmisCommon.createDatepicker();

		var me = this;
		var option = $.extend({},validation_option, {
			onValidationComplete: function(form, status){
				if(status) me.save();
			}
		});

		$("#FrmReserveInput").validationEngine('attach',option);

		//환자검색
		this.createAutocomplete();
	},
	save: function() {
		var me = this;
		var formdata = $('#FrmReserveInput').serialize();
		$.ajax({
			url:'/treat_proc/save_reserve',
			data:formdata,
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) {
					$('.modal-close').trigger('click');	
					// if(r.data.mode == 'insert') {
					// 	if(me.referer == 'info') {
					// 		PatientInfo.patient_no = r.data.no;
					// 		PatientInfo.render();
					// 	}
					// }
					// else {
					// 	PatientInfo.load('basic');
					// }
				}
				else {
					HmisAlert.alert(r.msg);
				}
			}
		});
	},
	loadUser: function(team_code, user_id, prefix) {
		console.log(user_id);
		var prefix = prefix || 'sb';
		var team_code = team_code || $('#'+prefix+'_team').val();
		$.ajax({
			url:'/manage/get_user_json',
			data:{
				team_code:team_code
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var sb = $('#'+prefix+'_user');
				if(r.success && team_code!=''){
					sb.find('option[value!=""]').remove();
					var selected;
					$.each(r.data, function(i,e){
						selected = (i==user_id)?'selected':'';
						sb.append('<option value="'+i+'" '+selected+'>'+e+'</option>');
					});
					sb.css('display','');
				}
				else {
					sb.val('');
					sb.css('display','none');	
				}
			}
		});
	},
	selectPatient: function(data) {
		console.log(data);
		$.each(data, function(i,e) {
			switch(i) {
				case 'no':
					$('[name="patient_no"]').val(e);
				break;
				case 'agree_privacy':
				case 'agree_email':
				case 'agree_sms':
					if(e == 'Y') {
						$('[name="'+i+'"]').prop('checked',true);	
					}
					
				break;
				case 'chart_no':
					$('#chart_no').html(e);
				break;
				case 'sex':
					$('[name="sex"][value="'+e+'"]').prop("checked",true);
				break;
				case 'manager_team_code':
					$('[name="manager_team_code"] option[value="'+e+'"]').prop("selected",true);
					$('[name="reserve[manager_team_code]"] option[value="'+e+'"]').prop("selected",true);
					ReserveInput.loadUser(e, data.manager_id);
					ReserveInput.loadUser(e, data.manager_id, 'reserve');
				break;
				default:
					$('[name="'+i+'"]').val(e);
					$('[name="reserve['+i+']"]').val(e);
				break;
			}

			// console.log(i,e);
		})
	},
	createAutocomplete: function(){
		var me = this;
		var el = $('#search_reserve_patient');
		el.autocomplete({
			minLength: 1,
			disabled: true,
			select: function(event, ui) {
				if(ui.item.rs.no > 0) {
					me.selectPatient(ui.item.rs);	
				}
			
				$(this).val('');
				return false;

			},
			source:function(request, response) {
				$.ajax({
					url: "/patient/patient_list",
					data:{
						search_word:request.term
					},
					dataType: "json",
					type:'POST',
					success: function (r) {
						if(r.success) {
							response($.map(r.data, function(v,i){
								return {
									label: v.name+' - '+v.search,
									value: v.name,
									rs:v
								};
							}));
						}
						else {
							response([{
								label:'"'+request.term+'" 으로 검색된 환자가 없습니다.',
								value:'',
								no:''
							}]);
						}
					}
				})
			}
		}).on('keypress',function(e){
			if(e.keyCode === 13) {
				if(el.val().length<2) {
					HmisAlert.alert('최소 2자리 이상 입력후 검색하세요.', function(){ el.focus(); });
					return false;
				}
				el.autocomplete('enable');
				el.autocomplete("search",el.val());
			}
			else {
				el.autocomplete('disable');
			}
		}).on('keyup',function(e) {
			if ((e.keyCode == 8) || (this.value == "") || (e.keyCode == 46)){
				el.autocomplete("disable");
			}
		});
	},
	//진료항목추가
	addTreat: function() {
		var id = $('#sb_treat_region').val()+'_'+$('#sb_treat_item').val();
		var text = $('#sb_treat_region option:selected').text()+' > '+$('#sb_treat_item option:selected').text();
		var target = $('#treat_list');

		if(target.find('span#'+id).length>0) {
			HmisAlert.alert('동일한 진료항목이 이미 선택되었습니다.');
			return false;
		}

		var tbl = $('<span class="label label-default" style="margin-top:0px;margin-bottom:0px" id="'+id+'">'+text+' <i class="fa fa-times fa-1" style="margin-left:10px;cursor:pointer;vertical-align: -1px"></i></label>');
		tbl.find('i').on('click.treat', function() {ReserveInput.removeTreat(id);});
		target.append(tbl);
		this.buildTreat();
	},
	//진료항목제거
	removeTreat: function(id) {
		$('#treat_list > span#'+id).remove();
		this.buildTreat();
	},
	buildTreat: function() {
		if($('#treat_list > span').length>0) {
			$('#treat_null').css('display','none');
		}
		else {
			$('#treat_null').css('display','');
		}
	},
	loadTreatItem: function(region_code, item_code) {
		var region_code = region_code || $('#sb_treat_region').val();
		$.ajax({
			url:'/patient/get_treat_item',
			data:{
				region_code:region_code
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var sb = $('#sb_treat_item');
				if(r.success && region_code!=''){
					sb.find('option[value!=""]').remove();
					var selected;
					$.each(r.data, function(i,e){
						selected = (i==item_code)?'selected':'';
						sb.append('<option value="'+i+'" '+selected+'>'+e+'</option>');
					});
					sb.css('display','');
				}
				else {
					sb.val('');
					sb.css('display','none');	
				}
			}
		});
	},
	reset: function() {
		HmisAlert.confirm('입력하신 데이터를 초기화하시겠습니까?',function(r) {
			if(r) {
				HmisCommon.formReset('FrmReserveInput');
				$('#chart_no').html('신규환자');
				$('#FrmReserveInput').validationEngine('hide');
			}
		})
	}
}

$(function(){
	ReserveInput.init();
})
</script>