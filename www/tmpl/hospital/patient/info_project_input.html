<form id="FrmPatientProjectInput" onsubmit="return false">
		<input type="hidden" name="patient_no" value="{rs.patient_no}" />
		<input type="hidden" name="project_no" value="{rs.no}" />
		<input type="hidden" name="mode" value="{mode}" />
		<input type="hidden" name="paid_total" value="{rs.paid_total}" /> <!-- 수납액 -->
		<input type="hidden" name="amount_refund" value="{rs.amount_refund}" /> <!-- 환불액 -->
		
		<table class="table table-bordered table-form">
			<colgroup>
				<col style="width:120px" />
				<col />
				<col style="width:120px" />
				<col style="width:200px" />
			</colgroup>
			<tbody>
				<tr>
					<th>구분</th>
					<td>
						<label class="hmis"><input type="radio" name="type" value="1" class="hmis" {? rs.type_idx==1}checked{/} data-ui="change" /><span class="lbl"> 수술</span></label>
						<label class="hmis"><input type="radio" name="type" value="2" class="hmis" {? rs.type_idx==2}checked{/} data-ui="change" /><span class="lbl"> 시술</span></label>
						<label class="hmis"><input type="radio" name="type" value="4" class="hmis" {? rs.type_idx==4}checked{/} data-ui="change" /><span class="lbl"> 피부</span></label>
						<label class="hmis"><input type="radio" name="type" value="3" class="hmis" {? rs.type_idx==3}checked{/} data-ui="change" /><span class="lbl"> 진료</span></label>
						<label class="hmis"><input type="radio" name="type" value="5" class="hmis" {? rs.type_idx==5}checked{/} data-ui="change" /><span class="lbl"> 판매</span></label>
					</td>
					<th>수술/시술일자</th>
					<td>
						<input type="text" name="date_project" value="{rs.date_project}" class="validate[required] datepicker lg" data-errormessage-value-missing="수술/시술일자를 입력하세요." {? !rs.date_project}disabled{/}/>
						<label class="hmis" style="margin-left:5px"><input type="checkbox" name="date_project_undecided" value="yes" class="hmis" {? !rs.date_project}checked{/}><span class="lbl"> 미정</span></label>
					</td>
				</tr>
				<tr>
					<th>담당의사</th>
					<td>
						<select name="doctor_id">
							<option value="">::담당의사::</option>
							{@ cfg.doctor}
							<option value="{.key_}" {? .key_== rs.doctor_id}selected{/} >{.value_}</option>
							{/}
						</select>
					</td>
					<th>담당실장</th>
					<td>
						<select name="manager_team_code" id="sb_team" onchange="PatientProjectInput.loadUser(this.value)">
							<!-- <option value="">::팀::</option> -->
							{@ cfg.manager_team}
							<option value="{.key_}" {? .key_== rs.manager_team_code}selected{:}{?  layout.login.info.ss_team_code!='43'}disabled{/}{/} >{.value_}</option>
							{/}
						</select>
						<select name="manager_id" id="sb_user" style="display:none">
							<option value="">::팀원::</option>
						</select>
					</td>
				</tr>
				<tr>
					<th>간호사</th>
					<td colspan="3">
						{@ cfg.nurse}
						<label class="hmis"><input type="checkbox" name="nurse_id[]" value="{.key_}" class="hmis" {? in_array(.key_, rs.nurse_list)}checked{/}/><span class="lbl"> {.name}</span></label>
						{/}
					</td>
				</tr>
				<tr>
					<th>진료구분</th>
					<td>
						<label class="hmis"><input type="radio" name="tax_type" value="tax" class="hmis" {? rs.tax_type=='tax'}checked{/} /><span class="lbl"> 과세진료</span></label>
						<label class="hmis"><input type="radio" name="tax_type" value="free" class="hmis" {? rs.tax_type=='free'}checked{/} /><span class="lbl"> 면세진료</span></label>
					</td>
					<th>상담팀매출여부</th>
					<td>
						<label class="hmis"><input type="checkbox" name="consulting_sales_yn" value="Y" class="hmis" {? rs.consulting_sales_yn=='Y'}checked{/} /><span class="lbl"></span></label>
					</td>
				</tr>
	
				<tr>
					<th rowspan="2">진료부위</th>
					<td colspan="3">
						<!--{*
						<select name="treat_region" id="sb_treat_region" onchange="HmisTreat.loadTreatItem(this.value)">
							<option value="">::진료부위::</option>
							{@ cfg.treat_region}
							<option value="{.key_}"  {?rs.treat_region_code == .key_}selected{/} >{.value_}</option>
							{/}
						</select>
						<select name="treat_item" id="sb_treat_item" style="display:none" onchange="HmisTreat.addTreat()">
							<option value="">::진료항목::</option>
						</select>
						*}-->
		
						<button type="button" onclick="HmisCommon.treat('PatientProjectInput.callbackTreat','{parient.treat_cost_no}')" class="btn btn-flat-lightgray btn-onlyicon"><i class="fa fa-search fa-1"></i></button>
					</td>
				</tr>
				<tr>
					<td colspan="3" style="padding-bottom:0px">
						<input type="hidden" name="cost" id="treat_cost"  value="{rs.cost}">
						<input type="hidden" name="treat_costs" value="{rs.treat_costs}">
						
						<div id="treat_null" style="padding:7px 0px 13px;{? rs.treat_info}display:none{/}">진료부위를 선택하세요.</div>
						<div id="treat_list">
							{@ rs.treat_info}
							<span class="label label-default" id="{.key_}"  data-cost='{.json}'>{.nav} <i class="fa fa-times fa-1" style="margin-left:10px;cursor:pointer;vertical-align: -1px" onclick="PatientProjectInput.removeTreat('{.key_}');"></i></span>
							{/}
						</div>
					</td>
				</tr>
	
				<!--{*
				<tr data-ui-group="type" data-ui-value="1 2">
					<th>진료부위</th>
					<td colspan="3">
						<span id="treat_nav">{rs.treat_nav}</span>
						<input type="hidden" id="treat_cost_no" name="treat_cost_no" value="{rs.treat_cost_no}">
						<button type="button" onclick="HmisCommon.treat('PatientProjectInput.callbackTreat','')" class="btn btn-flat-lightgray btn-onlyicon"><i class="fa fa-search fa-1"></i></button>
						<button type="button" onclick="PatientProjectInput.resetTreat()" id="btn_treat_reset" class="btn btn-flat-lightgray btn-onlyicon {? !rs.treat_cost_no}hide{/}"><i class="fa fa-times fa-1"></i></button>
					</td>
				</tr>
				*}-->
				<tr data-ui-group="type" data-ui-value="1 2">
					<th>수술유형</th>
					<td colspan="3">
						<label class="hmis"><input type="radio" name="op_type" value="origin" class="hmis" {? rs.op_type=='origin'}checked{/} /><span class="lbl"> 기본</span></label>
						<label class="hmis"><input type="radio" name="op_type" value="re" class="hmis" {? rs.op_type=='re'}checked{/} /><span class="lbl"> 재수술</span></label>
						<label class="hmis"><input type="radio" name="op_type" value="rev" class="hmis" {? rs.op_type=='rev'}checked{/} /><span class="lbl"> Rev</span></label>
						<label class="hmis"><input type="radio" name="op_type" value="abroad_1" class="hmis" {? rs.op_type=='abroad_1'}checked{/} /><span class="lbl"> Private</span></label>
						<label class="hmis"><input type="radio" name="op_type" value="abroad_2" class="hmis" {? rs.op_type=='abroad_2'}checked{/} /><span class="lbl"> 해외</span></label>
						<label class="hmis"><input type="radio" name="op_type" value="service" class="hmis" {? rs.op_type=='service'}checked{/} /><span class="lbl"> 서비스</span></label>
						<span class="label label-xs label-orange">수가</span> <span id="cost" >{=number_format(rs.cost)}</span>원
					</td>
				</tr>
		
				<tr>
					<th>총매출액</th>
					<td>
						<input type="text" name="amount_basic" class="validate[custom[numberFormat]] number required" value="{=number_format(rs.amount_basic)}"/>
					</td>
					<th>수가대비(차액)</th>
					<td>
						<div class="minheight"><span id="discount_rate">{rs.discount_rate}</span>%(<span id="discount_amount">{=number_format(rs.discount_amount)}</span>원)</div>
					</td>
				</tr>
				{? mode == 'update'}
				<tr data-ui-group="type" data-ui-value="1 2">
					<th>재료비</th>
					<td>
						<input type="text" name="amount_material" class="validate[custom[numberFormat]] number transparent" readonly value="{=number_format(rs.amount_material)}" />
					</td>
					<th>OP매출</th>
					<td>
						<div class="minheight"><span id="amount_op">0</span>원</div>
					</td>
				</tr>
				{/}
				<tr>
					<th>특이사항</th>
					<td colspan="3"><textarea name="comment" class="hmis">{rs.comment}</textarea></td>
				</tr>
			</tbody>
		</table>
		
		<div class="area-button">
			<button type="submit" class="btn btn-theme btn-lg">저장</button>
			<button type="button" class="btn btn-gray btn-lg modal-close">닫기</button>
		</div>
		</form>
		
		<script type="text/javascript">
		var PatientProjectInput = {
			frm:$('#FrmPatientProjectInput'),
			treat:{},
			init: function() {
				var me = this;
				var option = $.extend({},validation_option, {
					display:'alert',
					showOneMessage:true,
					validationEventTrigger:'submit',
					onValidationComplete: function(form, status){
						if(status) me.save();
					}
				});
		
				this.frm.validationEngine('attach',option);
		
				HmisCommon.createDatepicker();
		
				$('input[name="op_type"], input[name="amount_total"]').on('change', function() {
					me.setCost.apply(me)
				});
		
				$.each($('[data-ui]'), function(i,e) {
					me.setUI(this.name);
					var evt = $(e).data('ui');
					$(this).on(evt,function() {
						me.setUI(this.name);
					});
				});
		
				this.createNumber();
				//this.setCost();
				HmisCommon.loadUser('{rs.manager_team_code}','{rs.manager_id}');
		
				$('input[name="date_project_undecided"]').on('click', function() {
					var target = $('input[name="date_project"]');
					target.attr('disabled', this.checked);
				});

				$.each($('#treat_list span'), function(i,e) {
					me.treat[e.id] = $(e).data('cost');
				});
		
				//$('input[name="date_project_undecided"]').trigger('click');
			},
			callbackTreat: function(d) {
				HmisTreat.addTreat(d);
				this.treat[d.no] = d;
				console.log(this.treat);
				//수가 재계산
				this.setCost();
		
			},
			removeTreat: function(no) {
				HmisTreat.removeTreat(no);
				delete this.treat[no]; 
	
				console.log(no);
				console.log(this.treat);
	
				//수가 재계산
				this.setCost();
			},
			createNumber : function() {
				var me = this;
				$("input.number").attr('placeholder','0');
				$("input.number").attr('autocomplete','off');
				$("input.number").unbind('keyup.number').bind('keyup.number', function(){
					var e = $(this);
					e.val( HmisCommon.numberFormat(e.val()));
					me.setCost.apply(me);
				})
			},
			setUI : function(name) {
				this.frm.validationEngine('hide');
				var v = HmisCommon.getValue(this.frm.find('[name="'+name+'"]'));
				var group = $('[data-ui-group="'+name+'"]');
				group.css('display','none');
				group.filter('[data-ui-value~="'+v+'"]').css('display','');
			},
			setCost: function() {
				var op_type = $('input[name="op_type"]:checked').val();//수술유형
				var cost = 0;//수가
				var discount_amount = 0; //할인금액
				var discount_rate = 0; //할인율
	
				$.each(this.treat, function(i,e) {
					cost+=parseInt(e.cost[op_type]);
				});
	
				$('#cost').html(HmisCommon.numberFormat(cost)); //정상수가
				$('#treat_cost').val(cost);
	
				//할인율계산
				var amount_basic = HmisCommon.getValue(this.frm.find('input[name="amount_basic"]')).toString().replace(/[^0-9]/gi,'');
				if(amount_basic<0) return false;
	
				discount_amount = amount_basic-cost;
				discount_rate = (cost>0)?(discount_amount)*100/cost:0;
				$('#discount_amount').html(HmisCommon.numberFormat(discount_amount));
				$('#discount_rate').html(Math.round(discount_rate));
		
				//op매출
				var amount_material = HmisCommon.getValue(this.frm.find('input[name="amount_material"]')).toString().replace(/[^0-9]/gi,'');
				var amount_refund = HmisCommon.getValue(this.frm.find('input[name="amount_refund"]')).toString().replace(/[^0-9]/gi,'');
				var amount_op  = amount_basic-(amount_material+amount_refund);
				$('#amount_op').html(HmisCommon.numberFormat(amount_op));
			},
			loadUser: function(team_code, user_id, prefix) {
				var prefix = prefix || 'sb';
				var team_code = team_code || $('#'+prefix+'_team').val();
				$.ajax({
					url:'/manage/get_user_json',
					data:{
						team_code:team_code
					},
					dataType:'json',
					type:'POST',
					success: function(r) {
						var sb = $('#'+prefix+'_user');
						if(r.success && team_code!=''){
							sb.find('option[value!=""]').remove();
							var selected;
							$.each(r.data, function(i,e){
								selected = (i==user_id)?'selected':'';
								sb.append('<option value="'+i+'" '+selected+'>'+e+'</option>');
							});
							sb.css('display','');
						}
						else {
							sb.val('');
							sb.css('display','none');
						}
					}
				});
			},
			save: function(){
	
				//진료부위정보세팅
				var no = [];
				$.each($('#treat_list span'), function(i,e) {
					no.push(this.id);
				});
	
				HmisCommon.setValue(this.frm.find('[name="treat_costs"]'), no.join());
	
				var formdata = $('#FrmPatientProjectInput').serializeArray();
				
				$.ajax({
					url:'/patient_proc/save_patient_project',
					data:formdata,
					dataType:'json',
					type:'POST',
					success: function(r) {
						if(r.success) {
							$('.modal-close').trigger('click');
							PatientInfo.loadProject(PatientInfo.project_no);
						}
						else {
							HmisAlert.alert(r.msg);
						}
					},
					beforeSend: function() {
						$('#FrmPatientProjectInput button[type="submit"]').attr('disabled', true);
						$('#FrmPatientProjectInput button[type="submit"]').html('<img src="/images/common/loading.gif" style="vertical-align:middle"/> 저장중..');
					}
				})
			}
		}
	
		HmisTreat.removeTreat = function(id) {
			console.log('test');
			$('#treat_list > span#'+id).remove();
			HmisTreat.buildTreat();
			delete PatientProjectInput.treat[id];
			PatientProjectInput.setCost();
		};
		
		$(function(){
			PatientProjectInput.init();
		})
		</script>
		