<? if($mode == 'insert') { ?>
<form id="FrmPatientInputSearch" onsubmit="return false">
<input type="hidden" name="group_code" value="<?=$rs['group_code']?>" />
<table class="table table-bordered table-form">
	<colgroup>
		<col width="120px">
		<col>

	</colgroup>
	<tbody>
		<tr>
			<th>상담고객 검색 <i class="fa fa-info-circle fa-1 f-info" data-rel="tooltip" title="상담기록이 있는 고객데이터에서 검색합니다."></i> </th>
			<td>
				<div>
					<input type="search" name="name" id="search_consluting" class="search" style="width:350px" autocomplete="off" placeholder="환자이름 or 휴대폰번호 or 메신저" /> 
					<button type="submit" class="btn btn-flat-blue" onclick="PatientInput.search()" ><i class="fa fa-search fa-1"></i> 검색</button>
					<button type="button" class="btn btn-gray" onclick="PatientInput.reset()"><i class="fa fa-refresh fa-1"></i> 처음으로</button>
				</div>
			</td>
		</tr>
	</tbody>
</table>
</form>
<div class="dashed" style="margin:10px 0px"></div>
<? } ?>

<form id="FrmPatientInput" onsubmit="return false">
<input type="hidden" name="mode" value="<?=$mode?>" /><!-- insert:추가 / update:수정 -->
<input type="hidden" name="no" value="<?=$rs['no']?>" />
<input type="hidden" id="messenger" value="" /><!-- 메신저 중복체크 -->
<input type="hidden" id="mobile" value="" /><!-- 휴대폰번호 중복체크 -->
<table class="table table-bordered table-form">
	<colgroup>
		<col width="100px">
		<col>
		<col width="100px">
		<col>
		<col width="100px">
		<col>
	</colgroup>
	<tbody>
		<tr>
			<th>이름</th>
			<td><input type="text" name="name" class="validate[required] full required" value="<?=$rs['name']?>" /></td>
			<th>주민등록번호</th>
			<td><input type="text" name="jumin" class="full" data-mask="jumin" value="<?=$rs['jumin']?>" /></td>
			<th>생년월일</th>
			<td>
				<input type="text" name="birth" class="" value="<?=$rs['birth']?>"  data-mask="date" style="width:110px" />
			</td>
		</tr>
		<tr>
			<th>성별</th>
			<td>
				<label class="hmis"><input type="radio" name="sex" value="M" class="hmis" <?=($rs['sex']=='M')?'checked':''?> /><span class="lbl"> 남</span></label>
				<label class="hmis"><input type="radio" name="sex" value="F" class="hmis" <?=($rs['sex']=='F')?'checked':''?> /><span class="lbl"> 여</span></label>
			</td>
			<th>휴대폰번호</th>
			<td><input type="text" name="mobile" value="<?=$rs['mobile']?>"  style="width:110px" class="validate[groupRequired[contacts]] required" data-mask="mobile"  data-errormessage-value-missing="휴대폰번호와 메신저 중 한개는 반드시 입력하세요."/> <button type="button" class="btn btn-flat-lightgray btn-onlyicon" onclick="PatientInput.checkDuplicate('mobile')"><i class="fa fa-check fa-1"></i></button></td>
			<th>유선전화</th>
			<td><input type="text" name="tel" value="<?=$rs['tel']?>" class="full" /></td>
		</tr>
		<tr>
			<th>메신저</th>
			<td><input type="text" name="messenger" value="<?=$rs['messenger']?>" style="width:110px" class="validate[groupRequired[contacts]] required"  data-errormessage-value-missing="휴대폰번호와 메신저 중 한개는 반드시 입력하세요." data-errormessage-pattern-mismatch="메신저 중복체크가 필요합니다."  /> <button type="button" class="btn btn-flat-lightgray btn-onlyicon" onclick="PatientInput.checkDuplicate('messenger')"><i class="fa fa-check fa-1"></i></button></td>
			<th>이메일</th>
			<td colspan="3"><input type="text" name="email" value="<?=$rs['email']?>" class="validate[custom[email]] full" /></td>
		</tr>
		<tr>
			<th rowspan="2">주소</th>
			<td colspan="5">
				<input type="text" name="zipcode" class="" value="<?=$rs['zipcode']?>" placeholder="우편번호" /> <button type="button" class="btn btn-flat-lightgray btn-onlyicon"><i class="fa fa-search fa-1"></i></button>
				<input type="text" name="address" value="<?=$rs['address']?>" style="width:500px" >
			</td>
		</tr>
		<tr>
			<td colspan="5">
				<input type="text" name="address_detail" value="<?=$rs['address_detail']?>" class="full" placeholder="상세주소">
			</td>
		<tr>
			<th>직업</th>
			<td>
				<select name="job_code">
					<option value="">::직업::</option>
					<? foreach($cfg['job'] as $job_code=>$job) {?>
					<option value="<?=$job_code?>" <?=($rs['job_code']==$job_code)?'selected':''?>><?=$job?></option>
					<? } ?>
				</select>
			</td>
			<th>직장명</th>
			<td><input type="text" name="company" class="full" value="<?=$rs['company']?>" /></td>
			<th>유입경로</th>
			<td>
				<select name="path_code">
					<option value="">::유입경로::</option>
					<? foreach($cfg['path'] as $path_code=>$path) {?>
					<option value="<?=$path_code?>" <?=($rs['path_code']==$path_code)?'selected':''?>><?=$path?></option>
					<? } ?>
				</select>
			</td>
		</tr>
		<tr>
			<th>담당의사</th>
			<td>
				<select name="doctor_id">
					<option value="">::담당의사::</option>
					<? foreach($cfg['doctor'] as $doctor_id=>$doctor_name) {?>
					<option value="<?=$doctor_id?>" <?=($rs['doctor_id']==$doctor_id)?'selected':''?>><?=$doctor_name?></option>
					<? } ?>
				</select>
			</td>
			<th>담당자</th>
			<td>
				<select name="manager_team_code" id="sb_team" onchange="PatientInput.loadUser(this.value)">
					<option value="">::팀선택::</option>
					<? foreach($cfg['team'] as $team_code=>$team_name) {?>
					<option value="<?=$team_code?>" <?=($rs['manager_team_code']==$team_code)?'selected':''?>><?=$team_name?></option>
					<? } ?>
				</select>
				<select name="manager_id" id="sb_user" style="display:none">
					<option value="">::팀원선택::</option>
				</select>
			</td>
			<th>소개자</th>
			<td>
				<input type="text" class="search full"/>
				<!-- <button type="button" class="btn btn-flat-lightgray btn-onlyicon"><i class="fa fa-search fa-1"></i></button> -->
			</td>
		</tr>
		<tr>
			<th>진료부위</th>
			<td colspan="5">
				<select name="treat_region_code" id="sb_treat_region" class="" onchange="PatientInput.loadTreatItem(this.value)">
					<option value="">::진료부위::</option>
					<? foreach($cfg['treat_region'] as $region_code=>$region_name) {?>
					<option value="<?=$region_code?>" <?=($rs['treat_region_code']==$region_code)?'selected':''?>><?=$region_name?></option>
					<? } ?>
				</select>
				<select name="treat_item_code" id="sb_treat_item" class="" style="display:none" >
					<option value="">::진료항목::</option>
				</select>
			</td>
		</tr>
		<tr>
			<th>선택사항</th>
			<td colspan="5">
				<label class="hmis"><input type="checkbox" name="agree_privacy" value="Y" class="hmis" <?=($rs['agree_privacy']=='Y')?'checked':''?> /><span class="lbl"> 개인정보수집 및 이용동의</span></label>
				<label class="hmis"><input type="checkbox" name="agree_sms" value="Y" class="hmis" <?=($rs['agree_sms']=='Y')?'checked':''?> /><span class="lbl"> SMS수신동의</span></label>
				<label class="hmis"><input type="checkbox" name="agree_email" value="Y" class="hmis" <?=($rs['agree_email']=='Y')?'checked':''?> /><span class="lbl"> 이메일수신동의</span></label>
			</td>
		</tr>
		<tr>
			<th>특이사항</th>
			<td colspan="5">
				<textarea type="text" name="comment" class="hmis" style="height:100px"><?=$rs['comment']?></textarea>
			</td>
		</tr>
	</tbody>
</table>

<div class="area-button">
	<button type="submit" class="btn btn-theme btn-lg">저장</button>
	<button type="button" class="btn btn-gray btn-lg modal-close">닫기</button>
</div>
</form>


<script language="javascript" src="/js/jquery.maskedinput.min.js"></script>
<script type="text/javascript">
var PatientInput = {
	init: function() {

		$('input[data-mask="jumin"]').mask('999999-9999999');
		$('input[data-mask="mobile"]').mask('019-9999-9999');
		$('input[data-mask="date"]').mask('9999/99/99');

		var me = this;
		var option = $.extend({},validation_option, {
			onValidationComplete: function(form, status){
				if(status) me.save();
			}
		});

		$("#FrmPatientInput").validationEngine('attach',option);

		//중복체크
		$('input[data-errormessage-pattern-mismatch]').on('blur.duplicate', function(){
			me.checkDuplicate(this.name);
		});

		//환자검색
		this.createAutocomplete();

		this.loadUser("<?=$rs['manager_team_code']?>","<?=$rs['manager_id']?>");
		this.loadTreatItem("<?=$rs['treat_region_code']?>","<?=$rs['treat_item_code']?>");
	},
	loadUser: function(team_code, user_id) {
		var team_code = team_code || $('#sb_team').val();
		$.ajax({
			url:'/manage/get_user_json',
			data:{
				team_code:team_code
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var sb = $('#sb_user');
				if(r.success && team_code!=''){
					sb.find('option[value!="all"]').remove();
					var selected;
					$.each(r.data, function(i,e){
						selected = (i==user_id)?'selected':'';
						sb.append('<option value="'+i+'" '+selected+'>'+e+'</option>');
					});
					sb.css('display','');
				}
				else {
					sb.val('all');
					sb.css('display','none');	
				}
			}
		});
	},
	loadTreatItem: function(region_code, item_code) {
		var region_code = region_code || $('#sb_treat_region').val();
		$.ajax({
			url:'/patient/get_treat_item',
			data:{
				region_code:region_code
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var sb = $('#sb_treat_item');
				if(r.success && region_code!=''){
					sb.find('option[value!=""]').remove();
					var selected;
					$.each(r.data, function(i,e){
						selected = (i==item_code)?'selected':'';
						sb.append('<option value="'+i+'" '+selected+'>'+e+'</option>');
					});
					sb.css('display','');
				}
				else {
					sb.val('');
					sb.css('display','none');	
				}
			}
		});
	},
	search: function() {
		var search_el = $("#search_consluting");
		search_el.autocomplete('enable');
		search_el.autocomplete("search", search_el.val());
	},
	selectPatient: function(data) {
		$.each(data, function(i,e) {
			switch(i) {
				case 'tel':
					$('[name="mobile"]').val(e);
				break;
				case 'addr':
					$('[name="address"]').val(e);
				break;
				case 'sex':
					$('[name="sex"][value="'+e+'"]').prop("checked",true);
				break;
				case 'team_code':
					$('[name="manager_team"] option[value="'+e+'"]').prop("selected",true);
					PatientInput.loadUser(e, data.charge_user_id);
				break;
				default:
					$('[name="'+i+'"]').val(e);
				break;
			}

			// console.log(i,e);
		})
	},
	createAutocomplete: function(){
		var me = this;
		var el = $('#search_consluting');
		el.autocomplete({
			minLength: 1,
			disabled: true,
			select: function(event, ui) {
				if(ui.item.rs.cst_seqno > 0) {
					me.selectPatient(ui.item.rs);	
				}
			
				$(this).val('');
				return false;

			},
			delay:500,
			source:function(request, response) {
				$.ajax({
					url: "/patient/consulting_list",
					data:{
						search_word:request.term
					},
					dataType: "json",
					type:'POST',
					success: function (r) {
						if(r.success) {
							response($.map(r.data, function(v,i){
								return {
									label: v.name+' - '+v.search,
									value: v.name,
									rs:v
								};
							}));
						}
						else {
							response([{
								label:'"'+request.term+'" 으로 검색된 상담고객이 없습니다.',
								value:'',
								no:''
							}]);
						}
					}
				})
			}
		}).on('keypress',function(e){
			if(e.keyCode === 13) {
				if(el.val().length<2) {
					HmisAlert.alert('최소 2자리 이상 입력후 검색하세요.', function(){ el.focus(); });
					return false;
				}
				el.autocomplete('enable');
				el.autocomplete("search",el.val());
			}
			else {
				el.autocomplete('disable');
			}
		}).on('keyup',function(e) {
			if ((e.keyCode == 8) || (this.value == "") || (e.keyCode == 46)){
				el.autocomplete("disable");
			}
		});
	},
	checkDuplicate : function(field) {
		var el = $('input[name="'+field+'"]');
		var value = el.val();
		$.ajax({
			url:'/patient_proc/check_duplicate',
			data:{
				patient_no:'',
				field:field,
				value:value
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success){
					el.validationEngine('hide');
					$('#'+field).val(value);
				}
				else {
					$('#'+field).val('');

					el.validationEngine('showPrompt','이미 존재하는 환자정보입니다.','','topLeft',true);
					// HmisAlert.alert('이미 존재하는 환자정보입니다.');
				}
			}
		})
	},
	save: function() {
		var me = this;
		var formdata = $('#FrmPatientInput').serialize();
		$.ajax({
			url:'/patient_proc/save_patient',
			data:formdata,
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) {
					$('.modal-close').trigger('click', [r.data]);	
				}
				else {
					HmisAlert.alert(r.msg);
				}
			}
		});
	},
	reset: function() {
		HmisAlert.confirm('입력하신 데이터를 초기화하시겠습니까?',function(r) {
			if(r) {
				HmisCommon.formReset('FrmPatientInput');
			}
		})
	}
};
$(function() {
	PatientInput.init();
})
</script>