<style>
#classify_list .fa {
	color:#E3E3E3;	
}

#classify_list tr.selected .fa{
	color:#FF5722;
}

tr.selected td{
	background-color:#F5F5F5;	
}

tr.selected th {
}

</style>


<div style="width:400px;float:left;margin:10px;">
	<!-- 메뉴:S -->
	<h3 class="area-title">
		과목 목록
		<div class="button-box">
			<button class="btn btn-flat-green" onclick="StockSettings.openClassify('000S')"><i class="fa fa-plus fa-1"></i> 과목추가 </button>
		</div>
	</h3>
	<table class="table table-bordered table-hover table-list" style="margin-top:5px">
		<colgroup>
			<col width="80px">
			<col width="80px">
			<col>
			<col width="20px">
		</colgroup>
		<tbody id="subject_list"></tbody>
	</table>
</div>


<div style="width:1px;float:left;border-right:solid 1px #E3E3E3;min-height:800px;margin-top:15px;"></div>
<div style="width:400px;float:left;margin:10px;">
	<!-- 메뉴:S -->
	<h3 class="area-title">
		분류 목록
		<div class="button-box">
			<button class="btn btn-flat-blue" onclick="StockSettings.openClassify('000H')"><i class="fa fa-plus fa-1"></i> 분류추가 </button>
		</div>
	</h3>
	<table class="table table-bordered table-hover table-list" style="margin-top:5px">
		<colgroup>
			<col width="80px">
			<col width="80px">
			<col>
			<col width="20px">
		</colgroup>
		<tbody id="classify_list"></tbody>
	</table>
</div>



<div style="width:1px;float:left;border-right:solid 1px #E3E3E3;min-height:800px;margin-top:15px;"></div>
<div style="width:400px;float:left;margin:10px;display:none" id="item_wrap">
	<h3 class="area-title">
		<span class="f-error" id="classify_name"></span> 의 하위 분류
		<div class="button-box">
			<button class="btn btn-flat-purple" onclick="StockSettings.openItem()"><i class="fa fa-plus fa-1"></i> 항목추가</button>
		</div>
	</h3>
	<table class="table table-bordered table-hover table-list" style="margin-top:5px">
		<colgroup>
			<col width="80px">
			<col width="80px">
			<col>
		</colgroup>
		<tbody id="item_list">
		</tbody>
	</table>
</div>

<textarea id="tmpl_classify" style="display:none">
	<tr id="classify_${\code_parent}_${\code}" data-code="${\code_parent}_${\code}" data-name="${\name}" data-use="${\is_use}">
		<td><a href="javascript:;" onclick="StockSettings.openClassify('${\code_parent}', '${\no}')" class="link">${\code}</a></td>
		<td>
			<a href="javascript:;" onclick="StockSettings.setUse('${\no}', '${\is_use}', '${\kind}')">
			{if is_use=='Y'}
			<span class="label label-xs label-theme">사용</span>
			{else if}
			<span class="label label-xs">미사용</span>
			{/if}
			</a>
		</td>
		<td class="left" style="border-right:0px;cursor:pointer" onclick="StockSettings.loadItem('${\code_parent}_${\code}');">
			${\name}
		</td>
		<td style="border-left:0px">
			{if code_parent != '000S'}
			<i class="fa fa-chevron-right"></i>
			{/if}
		</td>
	</tr>
</textarea>

<textarea id="tmpl_item" style="display:none">
	<tr>
		<td><a href="javascript:;" onclick="StockSettings.openItem('${\no}')" class="link">${\code}</a></td>
		<td>
			<a href="javascript:;" onclick="StockSettings.setUse('${\no}', '${\is_use}','item')">
			{if is_use=='Y'}
			<span class="label label-xs label-theme">사용</span>
			{else if}
			<span class="label label-xs">미사용</span>
			{/if}
			</a>
		</td>
		<td class="left">
			${\name}
		</td>
	</tr>
</textarea>

<script language="javascript" src="/js/template.js"></script>
<script type="text/javascript">
var StockSettings = {
	classify_code:'',
	group_code:"{cfg.group}",
	init: function() {
		this.loadClassify('000H');
		this.loadClassify('000S');
	},
	loadClassify: function(classify_code){

		var kind = 'classify';
		var group_code = this.group_code;

		var code = classify_code.split('_')[0];
		if(code == '000S'){
			kind = 'subject';
			group_code = code;
		}


		var me = this;
		$.ajax({
			url:'/stock/category_list',
			data:{
				kind:kind,
				code_parent:group_code
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var tmpl = TrimPath.parseDOMTemplate('tmpl_classify');
				var target = $('#classify_list');
				if(code == '000S'){
					target = $('#subject_list');
				}
				target.empty();
				if(r.success) {
					var html = '';
					$.each(r.data, function(i,e){
						html += tmpl.process(e);
					});
					target.append(html);

					if(code != '000S'){
						classify_code = classify_code || $('#classify_list > tr:first').data('code'); 
						me.loadItem(classify_code);
						$('#item_wrap').show();
					}
				}
				else {
					target.append('<tr><td colspan="4">등록된 재고분류가 없습니다.</td></tr>');
				}
			}
		})
	},
	openClassify: function(group, no){
		var title='';
		var modal = new HmisModal('modal_classify', {width:500, top:200});
		if(group=='000S'){
			title = (no)?'과목 수정':'과목 추가';
			modal.open(title,'/stock/classify_input', {no:no, code_parent:group});
		}
		else{
			title = (no)?'분류 수정':'분류 추가';
			modal.open(title,'/stock/classify_input', {no:no, code_parent:this.group_code});
		}
		
		
	},
	loadItem: function(classify_code){
		var code = classify_code.split('_')[0];
		if(code == '000S'){
			return;
		}


		this.classify_code = classify_code;
		$('#classify_list > tr').removeClass('selected');
		$('#classify_'+classify_code).addClass('selected');
		$('#classify_name').html($('#classify_'+classify_code).data('name'));
		var me = this;
		$.ajax({
			url:'/stock/category_list',
			data:{
				kind:'item',
				code_parent:classify_code
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var tmpl = TrimPath.parseDOMTemplate('tmpl_item');
				var target = $('#item_list');
				target.empty();
				if(r.success) {
					var html = '';
					var classify_use = $('#classify_'+me.classify_code).data('use');
					$.each(r.data, function(i,e){
						if(classify_use == 'N') e.is_use = 'N';
						html += tmpl.process(e);
					});
					target.append(html);
				}
				else {
					target.append('<tr><td colspan="3">등록된 항목이 없습니다.</td></tr>');
				}
			}
		})

	},
	openItem: function(no) {
		var title = (no)?'항목 수정':'항목 추가';
		var modal = new HmisModal('modal_item', {width:500, top:200});
		modal.open(title,'/stock/item_input', {no:no, code_parent:this.classify_code});
	},
	setUse: function(no, is_use, group) {
		if(group == 'item') {
			var classify_use = $('#classify_'+this.classify_code).data('use');
			if(classify_use == 'N') {
				alert('상위 분류가 사용안함으로 설정되어 있습니다.');
				return false;
			}
		} 
		
		var me = this;
		var is_use = (is_use=='Y')?'N':'Y';
		$.ajax({
			url:'/stock_proc/category_use',
			data:{
				no:no,
				is_use:is_use
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) {
					if(group == 'subject'){
						me.loadClassify('000S');
					}
					else{
						me.loadClassify(me.classify_code);
					}
				}
			}
		})

	},
}

$(function(){
	StockSettings.init();
})
</script>