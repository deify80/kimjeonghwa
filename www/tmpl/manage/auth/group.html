<h3 class="area-title">관리그룹 검색</h3>
<form id="FrmGroupSearch" onsubmit="return false">
<table class="table table-bordered table-form">
	<colgroup>
		<col width="120px">
		<col>
		<col width="120px">
		<col>
	</colgroup>
	<tbody>
		<tr>
			<th>검색</th>
			<td><input type="text" name="word" style="width:50%" placeholder="그룹코드 or 그룹설명"></td>
			<th>사용여부</th>
			<td>
				<div class="btn-group hmis blue" data-toggle="buttons">
					<label class="btn "><input type="radio" name="is_use" value="all" data-role="search" ><span>전체</span></label>
					<label class="btn active"><input type="radio" name="is_use" value="Y" checked="" data-role="search"><span>사용함</span></label>
					<label class="btn"><input type="radio" name="is_use" value="N" data-role="search"><span>사용안함</span></label>
				</div>
			</td>
		</tr>
	</tbody>
</table>

<div class="area-button">
	<button type="submit" class="btn btn-lg btn-theme" onclick="AuthGroupList.load(1)"><i class="fa fa-search"></i> 검색</button>
	<button type="button" class="btn btn-lg btn-gray" onclick="AuthGroupList.reset()">처음으로</button>
</div>

</form>

<div class="dashed"></div>

<h3 class="area-title">
	관리그룹 목록
	<span class="f-small" style="font-weight:normal;font-size:11px;padding-left:10px">검색된 그룹 <span id="cnt_search" class="f-bold  f-error">0</span>개 <span class="split">|</span> 총 관리그룹 <span id="cnt_total"class="f-bold">0</span>개</span>
	<div class="button-box">
		<button class="btn btn-flat-blue" onclick="AuthGroupList.add()"><i class="fa fa-plus fa-1"></i> 그룹추가</button>
		<span class="split">|</span>
		<button class="btn btn-flat-orange" onclick="AuthGroupList.remove()"><i class="fa fa-trash fa-1"></i> 그룹삭제</button>
	</div>
</h3>
<table class="table table-bordered table-list table-striped table-hover">
	<colgroup>
		<col width="60px"><!-- 번호 -->
		<col width="40px"><!-- 선택 -->
		<col width="150px"><!-- 그룹코드 -->
		<col width="80px"><!-- 그룹코드 -->
		<col width="250px"><!-- 소속직원 -->
		<col ><!-- 코멘트 -->
		<col width="80px"><!-- 사용여부 -->
	</colgroup>
	<thead>
		<tr>
			<th>번호</th>
			<th><input type="checkbox" class="hmis" onclick="HmisCommon.toggleCheck(this, 'checked[]')"><span class="lbl"></span></th>
			<th>그룹코드</th>
			<th>권한유형</th>
			<th>권한범위</th>
			<th>그룹설명</th>
			<th>사용여부</th>
		</tr>
	</thead>
	<tbody id="group_list">
	</tbody>
</table>

<!-- 페이징:S -->
<div class="area-pagination" id="pagination">
</div>

<textarea id="tmpl_list" style="display:none">
	<tr>
		<td>${idx}</td>
		<td><input type="checkbox" class="hmis" name="checked[]" value="${no}"><span class="lbl"></span></td>
		<td><a href="javascript:;" onclick="AuthGroupList.modify('${no}')" class="link">${group_code}</a></td>
		<td>{if type=='include'} 포함 {else} 제외 {/if}</td>
		<td class="left">
			{for user in users_list}
			<div style="line-height:1.5em">${user}</div>
			{forelse}
			-
			{/for}
		</td>
		<td class="left">${comment}</td>
		<td><a href="javascript:;" onclick="AuthGroupList.setUse('${no}','${is_use}');"><i class="fa fa-check fa-1 {if is_use=='N'} f-null {/if}"></i></a></td>
	</tr>
</textarea>

<textarea id="tmpl_pagination" style="display:none">
	<ul class="pagination">
		<li><a href="javascript:;" onclick="AuthGroupList.load(${first})"><i class="fa fa-angle-double-left"></i></a></li>
		<li><a href="javascript:;" onclick="AuthGroupList.load(${prev})"><i class="fa fa-angle-left"></i></a></li>
		{for p in block}
		<li class="{if p.equal==1} active {/if}"><a href="javascript:;" onclick="AuthGroupList.load(${p.num})">${p.num}</a></li>
		<!-- <li><a href="javascript:;">2</a></li> -->
		{/for}
		<li><a href="javascript:;" onclick="AuthGroupList.load(${next})"><i class="fa fa-angle-right"></i></a></li>
		<li><a href="javascript:;" onclick="AuthGroupList.load(${last})"><i class="fa fa-angle-double-right"></i></a></li>
	</ul>
</textarea>

<script type="text/javascript" src="/js/bootstrap.button.js"></script>
<script language="javascript" src="/js/template.js"></script>
<script type="text/javascript">
var AuthGroupList = {
	page:1,
	init: function() {
		this.load(1);
		$('[data-role="search"]').on('change', function() {
			AuthGroupList.load();
		})
	},
	add: function() {
		var modal = new HmisModal('add', {width:700, top:200});
		modal.open('관리그룹 추가','/manage/auth_group_input');
	},
	modify: function(no) {
		var modal = new HmisModal('add', {width:700, top:200});
		modal.open('관리그룹 수정','/manage/auth_group_input',{no:no});
	},
	reset: function() {
		$('#FrmGroupSearch')[0].reset();
		this.load(1);
	},
	reload : function() {
		this.load(this.page);
	},
	load: function(page) {
		var p = page || 1;
		var me = this;
		var search = $('#FrmGroupSearch').serialize();

		$.ajax({
			url:'/manage/auth_group_list',
			data:{
				page:p,
				limit:15,
				search:search
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				var tmpl = TrimPath.parseDOMTemplate('tmpl_list');
				var target = $('#group_list');
				target.empty();
				if(r.success) {
					var html = '';
					$.each(r.data.list, function(i,e){
						html += tmpl.process(e);
					});
					target.append(html);

					var tmpl_page = TrimPath.parseDOMTemplate('tmpl_pagination');
					$('#pagination').empty().append(tmpl_page.process(r.data.paging));
				}
				else {
					target.append('<tr><td colspan="7">검색된 관리그룹이 없습니다.</td></tr>');
				}

				me.page = p;
				$('#cnt_total').html(HmisCommon.numberFormat(r.data.count.total));
				$('#cnt_search').html(HmisCommon.numberFormat(r.data.count.search));
			}
		})
	},
	loadTeam : function(dept_code) {
		var sb_team = $('#sb_team');

		if(!dept_code) {
			sb_team.val('').css('display','none');
			return false;
		}
		$.ajax({
			url:'/manage/get_team_json',
			data:{
				dept_code:dept_code
			},
			dataType:'json',
			type:'POST',
			success: function(r){

				if(r.success){
					sb_team.find('option[value!=""]').remove();
					$.each(r.data, function(i,e){
						sb_team.append('<option value="'+i+'">'+e+'</option>');
					});
					sb_team.css('display','');
				}
				else {
					sb_team.val('').css('display','none');
				}
			}
		});
	},
	remove :function() {
		var checked = HmisCommon.getChecked('checked[]');
		if (checked.length<1) {
			alert('삭제할 그룹을 선택하세요.');
			return false;
		}

		if(!confirm('삭제하시겠습니까?')) return false;

		var group_no = checked.map(function () {return this.value;}).get();
		var me = this;
		$.ajax({
			url:'/manage_proc/group_remove',
			data:{
				no:group_no
			},
			dataType:'json',
			type:'POST',
			success: function(r){
				if(r.success){
					me.reload();
				}
				else {
					alert(r.msg);
				}
			}
		})
	},
	setUse: function(no, use) {
		var me = this;
		$.ajax({
			url:'/manage_proc/group_set_use',
			data:{
				no:no,
				is_use:(use=='Y')?'N':'Y'
			},
			dataType:'json',
			type:'POST',
			success: function(r) {
				if(r.success) {
					me.reload();
				}
				else {
					alert(r.msg);
				}
			}
		})
	}
}

$(function() {
	AuthGroupList.init();
})
</script>
